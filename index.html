<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Big Crunch Assistant App</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Asistente de Tablero para el juego de mesa Big Crunch">
    <meta name="theme-color" content="#1f6feb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Big Crunch">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons (temporal - puedes crear iconos reales después) -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* TEMA ESPACIAL OSCURO MEJORADO */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0e14; /* Fondo muy oscuro */
            background-image: radial-gradient(circle at 50% 0%, #1c2333 0%, #0b0e14 70%);
            color: #c9d1d9;
        }
        
        h1, h2, .font-tech {
            font-family: 'Orbitron', sans-serif;
        }

        /* TARJETAS CON EFECTO DE CRISTAL/PROFUNIDAD */
        .card {
            background-color: rgba(22, 27, 34, 0.95);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #30363d;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            border-color: #58a6ff;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
        }

        /* BOTONES PERSONALIZADOS */
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1f6feb 0%, #1a56db 100%);
            border: 1px solid #388bfd;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #388bfd 0%, #1f6feb 100%);
            box-shadow: 0 0 15px rgba(56, 139, 253, 0.4);
        }

        .btn-secondary {
            background-color: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background-color: #30363d;
            border-color: #8b949e;
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #da3633 0%, #b62324 100%);
            border: 1px solid #f85149;
        }
        .btn-danger:hover {
            box-shadow: 0 0 15px rgba(218, 54, 51, 0.4);
        }

        /* CAJAS DE TEXTO/RESULTADOS */
        .output-box {
            background-color: #0d1117;
            border: 1px solid #30363d;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        /* OBJETIVO 15MW */
        .goal-display {
            background: linear-gradient(90deg, #2e1065 0%, #000000 100%);
            border: 2px solid #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
            text-shadow: 0 0 10px #a855f7;
        }

        /* RAREZAS DE ITEMS (ESTÉTICA) */
        .rarity-tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
            margin-left: auto;
        }
        .rarity-comun {
            background-color: #30363d;
            color: #8b949e; /* Gris */
            border: 1px solid #6e7681;
        }
        .rarity-raro {
            background-color: #0c2d6b; /* Azul oscuro fondo */
            color: #58a6ff; /* Azul brillante texto */
            border: 1px solid #1f6feb;
        }
        .rarity-epico {
            background-color: #2e1a4d; /* Lila oscuro fondo */
            color: #d2a8ff; /* Lila brillante texto */
            border: 1px solid #bc8cff;
            box-shadow: 0 0 5px rgba(188, 140, 255, 0.2);
        }

        /* ANIMACIÓN BIG CRUNCH */
        @keyframes crunchPulse {
            0% { border-color: #da3633; box-shadow: 0 0 0 0 rgba(218, 54, 51, 0.4); }
            50% { border-color: #f85149; box-shadow: 0 0 20px 5px rgba(218, 54, 51, 0.2); }
            100% { border-color: #da3633; box-shadow: 0 0 0 0 rgba(218, 54, 51, 0.4); }
        }
        .crunch-mode {
            animation: crunchPulse 2s infinite;
        }

        /* Estilos específicos para eventos */
        .event-section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .event-card {
            border-left-width: 4px;
            padding: 0.75rem;
            background: rgba(0,0,0,0.3);
            border-radius: 0 0.5rem 0.5rem 0;
            margin-bottom: 0.75rem;
        }
        
        .event-positive {
            border-left-color: #3fb950; /* Verde */
            background: linear-gradient(90deg, rgba(63, 185, 80, 0.1) 0%, transparent 100%);
        }
        
        .event-negative {
            border-left-color: #da3633; /* Rojo */
            background: linear-gradient(90deg, rgba(218, 54, 51, 0.1) 0%, transparent 100%);
        }

        /* Item dentro de evento */
        .event-item-preview {
            transform: scale(0.95);
            transform-origin: left top;
            margin-top: 0.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 300px;
        }
        
        /* MAPA VISUAL GRID MEJORADO */
        .map-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px; /* Pequeño espacio visual entre cartas */
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 600px; /* Un poco más grande para ver detalles */
            margin: 0 auto;
            background-color: #05070a;
            padding: 4px;
            border-radius: 8px;
        }
        
        .map-cell {
            background-color: rgba(22, 27, 34, 0.8);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 2px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        /* Fondos por nivel sutiles */
        .cell-lvl-1 { background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0) 80%); border-color: rgba(255,255,255,0.2); }
        .cell-lvl-2 { background: radial-gradient(circle, rgba(31, 111, 235, 0.15) 0%, rgba(0,0,0,0) 80%); border-color: rgba(31, 111, 235, 0.3); }
        .cell-lvl-3 { background: radial-gradient(circle, rgba(46, 160, 67, 0.15) 0%, rgba(0,0,0,0) 80%); border-color: rgba(46, 160, 67, 0.3); }
        .cell-lvl-4 { background: radial-gradient(circle, rgba(210, 153, 34, 0.15) 0%, rgba(0,0,0,0) 80%); border-color: rgba(210, 153, 34, 0.3); }
        .cell-lvl-5 { background: radial-gradient(circle, rgba(219, 109, 40, 0.15) 0%, rgba(0,0,0,0) 80%); border-color: rgba(219, 109, 40, 0.3); }

        /* Sistema Planetario Interno */
        .system-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .planet-node {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #1f2937; /* Default */
            border: 2px solid #4b5563;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 4px rgba(0,0,0,0.8);
            transition: transform 0.2s;
        }
        .planet-node:hover {
            transform: translate(-50%, -50%) scale(1.5);
            z-index: 20;
            cursor: help;
        }

        /* Colores de Planetas según el sistema (opcional, por ahora genéricos con borde blanco) */
        .planet-node.active-node {
            background-color: #f0f6fc;
            border-color: #8b949e;
        }

        /* Líneas de conexión SVG */
        .connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .connection-line {
            stroke: #ef4444; /* ROJO como en las cartas */
            stroke-width: 1.5px;
            opacity: 0.6;
        }

        .system-danger-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            animation: pulseDanger 2s infinite;
        }
        .system-danger-overlay::after {
            content: "X";
            font-size: 4rem;
            font-weight: 900;
            color: rgba(239, 68, 68, 0.6);
            transform: rotate(-10deg);
        }
        @keyframes pulseDanger {
            0% { background-color: rgba(239, 68, 68, 0.1); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
            100% { background-color: rgba(239, 68, 68, 0.1); }
        }

        /* Etiquetas flotantes (Badges) sobre planetas */
        .planet-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 8px;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            z-index: 30;
            border: 1px solid white;
            box-shadow: 0 0 2px black;
        }
        .badge-shop { background-color: #a371f7; }
        .badge-event { background-color: #3fb950; }
        .badge-portal { background-color: #0ea5e9; top: auto; bottom: -8px; }
        .badge-danger { background-color: #ef4444; bottom: -8px; right: auto; left: -8px; }

        .system-label-overlay {
            position: absolute;
            bottom: 2px;
            left: 2px;
            font-size: 0.4rem;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
            text-transform: uppercase;
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body class="p-2 sm:p-6 min-h-screen">

    <div class="max-w-6xl mx-auto">
        
        <!-- Header con Reset y Objetivo -->
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 border-b border-gray-700 pb-6 gap-6">
            <div>
                <h1 class="text-3xl sm:text-4xl font-black text-[#ffcc00] flex items-center gap-3 tracking-tight" style="text-shadow: 0 0 20px rgba(255, 204, 0, 0.2);">
                    <i data-lucide="rocket" class="w-8 h-8 sm:w-10 sm:h-10"></i>
                    BIG CRUNCH
                </h1>
                <span class="text-sm font-normal text-gray-500 tracking-normal opacity-70 ml-1">Asistente de Tablero v2.0</span>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                <!-- OBJETIVO DISPLAY -->
                <div class="goal-display px-6 py-3 rounded-xl flex items-center justify-center gap-3 text-white w-full sm:w-auto">
                    <i data-lucide="zap" class="w-6 h-6 text-purple-300 animate-pulse"></i>
                    <div class="flex flex-col">
                        <span class="text-xs text-purple-300 font-bold tracking-widest">OBJETIVO FINAL</span>
                        <span class="text-2xl font-black font-tech">15 MW</span>
                    </div>
                </div>

                <button onclick="resetGame()" class="btn btn-danger py-2 px-5 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2 text-sm whitespace-nowrap h-auto">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    REINICIAR
                </button>
            </div>
        </div>

        <!-- Indicador de Nivel -->
        <div id="level-container" class="card p-6 mb-6 rounded-2xl text-center border-t-4 border-[#1f6feb] relative overflow-hidden">
            <span id="phase-label" class="text-sm font-bold tracking-widest text-blue-400 uppercase mb-2 block">FASE: EXPANSIÓN UNIVERSAL</span>
            <div class="flex justify-center items-center gap-4">
                <span class="text-2xl font-semibold text-gray-400">NIVEL</span>
                <span id="current-level" class="text-7xl font-black text-white" style="text-shadow: 0 0 30px rgba(255,255,255,0.1);">1</span>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
            
            <!-- Left Column: Map & Events -->
            <div class="lg:col-span-7 flex flex-col gap-6">
                
                <!-- Mapa Visual -->
                <div class="card p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2 text-yellow-400">
                            <i data-lucide="map" class="w-6 h-6"></i>
                            Mapa Galáctico
                        </h2>
                        <button onclick="handleTurnCycle()" id="btn-next-level" class="btn btn-primary py-2 px-4 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2">
                            <i data-lucide="arrow-right-circle" class="w-4 h-4"></i>
                            SIGUIENTE TURNO
                        </button>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <!-- Grid Container -->
                        <div class="w-full md:w-2/3 bg-[#05070a] p-4 rounded-xl border border-gray-800 shadow-inner">
                            <div id="visual-map" class="map-grid">
                                <!-- Cells injected via JS -->
                            </div>
                        </div>
                        
                        <!-- Info Panel -->
                        <div class="w-full md:w-1/3 flex flex-col gap-4">
                            <div id="map-output" class="text-xs text-gray-400 bg-[#0d1117] p-3 rounded-lg border border-gray-700 h-full">
                                <p class="font-bold text-yellow-500 mb-1">ESTADO</p>
                                Nivel 1 Activo.
                            </div>
                            
                            <!-- Shop Generator Button embedded here for context -->
                            <div class="border-t border-gray-700 pt-4 mt-auto">
                                <h3 class="text-sm font-bold text-blue-400 mb-2 flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i> Tiendas
                                </h3>
                                <button onclick="generateShopLocations()" class="btn btn-secondary w-full py-2 rounded-lg text-xs font-bold text-gray-300 mb-2">
                                    UBICAR TIENDAS
                                </button>
                                <div id="shop-locations-details" class="text-xs text-gray-500 italic h-auto max-h-60 overflow-y-auto custom-scrollbar">
                                    Esperando generación...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eventos -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-400">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        3. Eventos de Turno
                    </h2>
                    <button onclick="generateEvent()" class="btn btn-danger w-full py-3 rounded-lg font-semibold shadow-md mb-4 bg-opacity-80">
                        GENERAR 3 EVENTOS
                    </button>
                    <div id="event-output" class="bg-[#0d1117] border border-gray-800 p-4 rounded-xl text-sm text-gray-300 flex flex-col gap-2 min-h-[150px]">
                        <div class="text-center italic text-gray-500 my-auto">Pulsa para generar los eventos...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Shop Inventory -->
            <div class="lg:col-span-5">
                <div class="card p-6 rounded-2xl border border-gray-700 h-full flex flex-col">
                    <div class="flex justify-between items-end mb-4 border-b border-gray-700 pb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2 text-green-400">
                            <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                            Mercado
                        </h2>
                        <div class="text-[10px] text-right space-y-1 font-mono text-gray-500">
                            <div><span class="inline-block w-2 h-2 rounded-full bg-[#30363d] mr-1"></span>Común 60%</div>
                            <div><span class="inline-block w-2 h-2 rounded-full bg-[#0c2d6b] mr-1"></span>Raro 30%</div>
                            <div><span class="inline-block w-2 h-2 rounded-full bg-[#2e1a4d] mr-1"></span>Épico 10%</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-3 mb-4">
                        <select id="shop-level-select" class="w-full p-2 rounded-lg bg-[#0d1117] border border-gray-600 text-white text-sm font-bold focus:ring-1 focus:ring-green-500 outline-none">
                            <option value="" disabled selected>Nivel de Tienda</option>
                            <option value="2">Nivel 2</option>
                            <option value="3">Nivel 3</option>
                            <option value="4">Nivel 4</option>
                            <option value="5">Nivel 5 (Épico)</option>
                        </select>
                        <button onclick="generateShopInventory()" class="btn btn-primary w-full py-2 px-4 rounded-lg font-bold shadow-lg flex justify-center items-center gap-2 bg-gradient-to-r from-green-600 to-teal-600 border-green-500 hover:from-green-500 hover:to-teal-500">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            GENERAR STOCK
                        </button>
                    </div>

                    <div id="shop-inventory-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 overflow-y-auto flex-grow content-start">
                        <div class="col-span-full text-center py-8 text-gray-500 border border-dashed border-gray-700 rounded-xl text-xs">
                            Genera la tienda para ver objetos.
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Sección de Instrucciones -->
        <div class="card p-6 rounded-2xl mt-6 border-t-4 border-cyan-500">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-cyan-400">
                <i data-lucide="book-open" class="w-6 h-6"></i>
                Instrucciones y Conceptos Clave
            </h2>
            
            <div class="space-y-4 text-sm text-gray-300">
                <!-- Orden de Turno -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2">
                        <i data-lucide="list-ordered" class="w-4 h-4"></i>
                        Orden de Turno
                    </h3>
                    <ol class="list-decimal list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Pasar al siguiente nivel:</strong> Usa el botón "SIGUIENTE TURNO" para avanzar de nivel.</li>
                        <li><strong class="text-white">Generar tiendas:</strong> Ubica las tiendas en el mapa usando "UBICAR TIENDAS".</li>
                        <li><strong class="text-white">Turno del jugador:</strong> Realiza tus acciones (movimiento, compras, etc.).</li>
                        <li><strong class="text-white">Eventos:</strong> Al final del turno, clica "GENERAR 3 EVENTOS". <span class="text-red-400 font-semibold">⚠️ El daño de los eventos se aplica inmediatamente al generar los eventos.</span></li>
                    </ol>
                </div>

                <!-- Daño de Eventos -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-red-500">
                    <h3 class="font-bold text-red-400 mb-2 flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                        Daño de Eventos
                    </h3>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Eventos negativos:</strong> Si estás en el sistema/planeta afectado cuando se generan los eventos, recibes el daño inmediatamente.</li>
                        <li><strong class="text-white">Excepción - Daño al pasar:</strong> Los únicos casos donde recibes daño fuera de la generación de eventos son:
                            <ul class="list-circle list-inside ml-4 mt-1 space-y-1">
                                <li><strong class="text-yellow-400">Planeta Rebelde:</strong> -1 de daño a 1 rango (al pasar por él).</li>
                                <li><strong class="text-yellow-400">Basura Espacial:</strong> -1 de daño (al pasar por él).</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <!-- Portales -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-green-500">
                    <h3 class="font-bold text-green-400 mb-2 flex items-center gap-2">
                        <i data-lucide="door-open" class="w-4 h-4"></i>
                        Portales
                    </h3>
                    <p class="text-gray-300 ml-2">
                        <strong class="text-white">Pasar por un portal NO cuenta como movimiento del personaje</strong>, pero <strong class="text-orange-400">gastas 1 de combustible</strong> al usarlo.
                    </p>
                </div>

                <!-- Explosión de Sistema -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-orange-500">
                    <h3 class="font-bold text-orange-400 mb-2 flex items-center gap-2">
                        <i data-lucide="flame" class="w-4 h-4"></i>
                        Explosión de Sistema
                    </h3>
                    <p class="text-gray-300 ml-2">
                        Cuando un sistema planetario explota, <strong class="text-white">ya no se puede pasar por ahí</strong> a menos que tengas la habilidad <strong class="text-cyan-400">Llave Temporal</strong>.
                    </p>
                </div>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURACIÓN GLOBAL ---
        let nivelActual = 1;
        let faseJuego = 'EXPANSION'; 
        let turnosParaBigCrunch = 1; 
        
        // ESTADO DEL MAPA (7x7 Grid)
        // Indices 0-48. Center is 24 (Row 3, Col 3).
        // Estructura: mapGrid[index] = { systemName: string, level: number, shops: number }
        let mapGrid = new Array(49).fill(null); 

        // --- DATA STRUCTURES ---
        
        // Mapeo inverso para busqueda rapida de sistema por planeta
        const PLANET_TO_SYSTEM_MAP = {};

        const SISTEMAS_POR_NIVEL = {
            1: { sistemas: ['Sistema_Tierra'], planetas: ['Planeta_Tierra_Base'] },
            2: {
                sistemas: ['Sistema_Agua', 'Sistema_Tierra_Elemental', 'Sistema_Viento', 'Sistema_Fuego'],
                planetas: ['Planeta_Gota', 'Planeta_Olas', 'Planeta_Roca', 'Planeta_Barro', 'Planeta_Botanico', 'Planeta_Torrnado', 'Planeta_Burbuja', 'Planeta_Chispa', 'Planeta_Magma', 'Planeta_Llamas']
            },
            3: {
                sistemas: ['Sistema_Prehistorico', 'Sistema_Medieval', 'Sistema_FarWest', 'Sistema_Futurista'],
                planetas: ['Planeta_HuevoDino', 'Planeta_Hueso', 'Planeta_Fosil', 'Planeta_Castillo', 'Planeta_Yelmo', 'Planeta_Escudo', 'Planeta_Cadenas', 'Planeta_GorroCowboy', 'Planeta_Dinamita', 'Planeta_Rueda', 'Planeta_Barril', 'Planeta_PlacaBase', 'Planeta_Neon', 'Planeta_Holograma']
            },
            4: {
                sistemas: ['Sistema_Pizza', 'Sistema_Deporte', 'Sistema_Chuche', 'Sistema_Windows'],
                planetas: ['Planeta_Queso', 'Planeta_Tomate', 'Planeta_Cebolla', 'Planeta_Pepperoni', 'Planeta_Champiñon', 'Planeta_Futbol', 'Planeta_Basket', 'Planeta_Voley', 'Planeta_Tenis', 'Planeta_Beisbol', 'Planeta_Piruleta', 'Planeta_Chicle', 'Planeta_Gominola', 'Planeta_Nube', 'Planeta_Archivos', 'Planeta_MiPC', 'Planeta_Papelera', 'Planeta_InternetExplorer']
            },
            5: {
                sistemas: ['Sistema_Geometria_Minimalista', 'Sistema_Gemas'],
                planetas: ['Planeta_Poligono_3', 'Planeta_Poligono_4', 'Planeta_Poligono_5', 'Planeta_Poligono_6', 'Planeta_Poligono_7', 'Planeta_Rubi', 'Planeta_Topacio', 'Planeta_Lapislazuli', 'Planeta_Esmalte', 'Planeta_Diamante']
            }
        };

        // Inicializar Mapa Inverso
        for(let lvl in SISTEMAS_POR_NIVEL) {
            const sysList = SISTEMAS_POR_NIVEL[lvl].sistemas;
            const planetList = SISTEMAS_POR_NIVEL[lvl].planetas;
            // Asumimos que la asignacion de planetas a sistemas es implicita en el orden o bloques? 
            // El PDF agrupa planetas bajo sistemas. Para simplificar la logica de "En que sistema esta el planeta",
            // vamos a asignar todos los planetas del nivel a sus sistemas.
            // Pero espera, el PDF lista "Sistema X -> Planeta A, Planeta B".
            // Necesito esa asociacion exacta para el mapa.
            // Voy a reconstruir un mapping manual rapido basado en el PDF para exactitud.
        }
        
        // Mapping exacto manual (PDF 1.2)
        const SYSTEM_PLANET_RELATION = {
            'Sistema_Tierra': ['Planeta_Tierra_Base'],
            'Sistema_Agua': ['Planeta_Gota', 'Planeta_Olas'],
            'Sistema_Tierra_Elemental': ['Planeta_Roca', 'Planeta_Barro', 'Planeta_Botanico'],
            'Sistema_Viento': ['Planeta_Torrnado', 'Planeta_Burbuja'],
            'Sistema_Fuego': ['Planeta_Chispa', 'Planeta_Magma', 'Planeta_Llamas'],
            'Sistema_Prehistorico': ['Planeta_HuevoDino', 'Planeta_Hueso', 'Planeta_Fosil'],
            'Sistema_Medieval': ['Planeta_Castillo', 'Planeta_Yelmo', 'Planeta_Escudo', 'Planeta_Cadenas'],
            'Sistema_FarWest': ['Planeta_GorroCowboy', 'Planeta_Dinamita', 'Planeta_Rueda', 'Planeta_Barril'],
            'Sistema_Futurista': ['Planeta_PlacaBase', 'Planeta_Neon', 'Planeta_Holograma'],
            'Sistema_Pizza': ['Planeta_Queso', 'Planeta_Tomate', 'Planeta_Cebolla', 'Planeta_Pepperoni', 'Planeta_Champiñon'],
            'Sistema_Deporte': ['Planeta_Futbol', 'Planeta_Basket', 'Planeta_Voley', 'Planeta_Tenis', 'Planeta_Beisbol'],
            'Sistema_Chuche': ['Planeta_Piruleta', 'Planeta_Chicle', 'Planeta_Gominola', 'Planeta_Nube'],
            'Sistema_Windows': ['Planeta_Archivos', 'Planeta_MiPC', 'Planeta_Papelera', 'Planeta_InternetExplorer'],
            'Sistema_Geometria_Minimalista': ['Planeta_Poligono_3', 'Planeta_Poligono_4', 'Planeta_Poligono_5', 'Planeta_Poligono_6', 'Planeta_Poligono_7'],
            'Sistema_Gemas': ['Planeta_Rubi', 'Planeta_Topacio', 'Planeta_Lapislazuli', 'Planeta_Esmalte', 'Planeta_Diamante']
        };

        // Llenar PLANET_TO_SYSTEM_MAP
        for (const [sys, planets] of Object.entries(SYSTEM_PLANET_RELATION)) {
            planets.forEach(p => PLANET_TO_SYSTEM_MAP[p] = sys);
        }

        const EVENTOS_NEGATIVOS = ['Evento_Explosion_Sistema', 'Evento_Sistema_Infectado', 'Evento_Basura Espacial', 'Planeta_Rebelde'];
        const EVENTO_OBJETOS_POOL = [
            { id: 'Combustible_Lata_Pequeña', tipoObjeto: 'Combustible', rareza: 'comun', desc: '+3 Combustible' },
            { id: 'Medkit_Pequeño', tipoObjeto: 'Vida', rareza: 'comun', desc: '+2 HP' },
            { id: 'Estelar_BrilloEstelar', tipoObjeto: 'Potencia', rareza: 'comun', potenciaValor: 1 },
            { id: 'Oscura_Pozo', tipoObjeto: 'Potencia', rareza: 'comun', potenciaValor: 1 }
        ];

        const ITEMS_POR_TIPO = {
            Combustible: [
                { id: 'Combustible_Lata_Pequeña', rareza: 'comun', niveles: [2, 3, 4, 5], desc: '+3 Combustible' },
                { id: 'Combustible_Lata_Media', rareza: 'raro', niveles: [3, 4, 5], desc: '+6 Combustible' },
                { id: 'Combustible_Tanque_Grande', rareza: 'epico', niveles: [4, 5], desc: '+10 Combustible' },
            ],
            Vida: [
                { id: 'Medkit_Pequeño', rareza: 'comun', niveles: [2, 3, 4, 5], desc: '+2 HP' },
                { id: 'Medkit_Medio', rareza: 'raro', niveles: [3, 4, 5], desc: '+4 HP' },
                { id: 'Medkit_Grande', rareza: 'epico', niveles: [4, 5], desc: '+6 HP' },
            ],
            Potencia: [
                { id: 'Estelar_BrilloEstelar', rareza: 'comun', niveles: [2, 3, 4, 5], potenciaValor: 1 },
                { id: 'Estelar_PulsoEstelar', rareza: 'raro', niveles: [3, 4, 5], potenciaValor: 2 },
                { id: 'Estelar_NucleoEstelar', rareza: 'epico', niveles: [4, 5], potenciaValor: 3 },
                { id: 'Oscura_Pozo', rareza: 'comun', niveles: [2, 3, 4, 5], potenciaValor: 1 },
                { id: 'Oscura_OrbitaDensa', rareza: 'raro', niveles: [3, 4, 5], potenciaValor: 2 },
                { id: 'Oscura_ColapsoGravitacional', rareza: 'epico', niveles: [4, 5], potenciaValor: 3 },
            ],
            Habilidad: [
                { id: 'Habilidad_Estelar_Chispa', rareza: 'raro', niveles: [2, 3], desc: 'ACTIVA: Mueve +1 planeta gratis al comprar Estelar.' },
                { id: 'Habilidad_Grav_AtraerObjeto', rareza: 'raro', niveles: [3, 4], desc: 'ACTIVA: Atrae objeto (dist 3).' },
                { id: 'Habilidad_ExpansiónTemporal', rareza: 'raro', niveles: [3, 4], desc: 'ACTIVA: Repite movimiento.' },
                { id: 'Habilidad_Estelar_Duplicacion', rareza: 'epico', niveles: [4, 5], desc: 'PASIVA: Estelares x2.' },
                { id: 'Habilidad_Grav_MasaDoble', rareza: 'epico', niveles: [4, 5], desc: 'PASIVA: Gravitatorias x2.' },
                { id: 'Habilidad_ProtecciónPlanetaria', rareza: 'epico', niveles: [4, 5], desc: 'PASIVA: -1 Daño.' },
                { id: 'Habilidad_LlaveTemporal', rareza: 'epico', niveles: [3, 4], desc: 'PASIVA: Permite pasar por sistemas planetarios explotados.' },
                { id: 'Habilidad_LlaveTemporal', rareza: 'raro', niveles: [4, 5], desc: 'PASIVA: Permite pasar por sistemas planetarios explotados.' },
                { id: 'Habilidad_EstabilizadorEstelar', rareza: 'epico', niveles: [2, 3], desc: 'ACTIVA: Evita la explosión inminente de un sistema planetario (un solo uso, donde sea del universo).' },
                { id: 'Habilidad_EstabilizadorEstelar', rareza: 'raro', niveles: [4, 5], desc: 'ACTIVA: Evita la explosión inminente de un sistema planetario (un solo uso, donde sea del universo).' },
                { id: 'Habilidad_CrearPortal', rareza: 'epico', niveles: [4, 5], desc: 'ACTIVA: Crea un portal de 2 o 3 planetas donde tú quieras del universo.' },
                { id: 'Habilidad_DisfrazRebelde', rareza: 'raro', niveles: [3, 4, 5], desc: 'PASIVA: No te afectan los planetas rebeldes.' },
            ],
            Especial: [
                { id: 'Carta_UltimaVoluntad_CorreoPrime', rareza: 'raro', niveles: [3], desc: 'Envía inventario al morir.' },
                { id: 'Carta_UltimaVoluntad_CorreoPrime', rareza: 'epico', niveles: [4, 5], desc: 'Envía inventario al morir.' },
            ]
        };

        const RAREZA_PROBABILIDAD = { 'comun': 0.60, 'raro': 0.30, 'epico': 0.10 };

        // --- UTILS ---
        function getRandomElement(arr) {
            if (!arr || arr.length === 0) return null;
            return arr[Math.floor(Math.random() * arr.length)];
        }
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        function generateRareza(forcedRarity = null, nivel = null) {
            if (forcedRarity) return forcedRarity;
            
            // Probabilidades según nivel
            let probComun, probRaro, probEpico;
            if (nivel === 5) {
                // Nivel 5: 100% épico
                probComun = 0;
                probRaro = 0;
                probEpico = 1.0;
            } else if (nivel === 4) {
                // Nivel 4: 50% común, 30% raro, 20% épico
                probComun = 0.50;
                probRaro = 0.30;
                probEpico = 0.20;
            } else {
                // Niveles 1-3: 60% común, 30% raro, 10% épico
                probComun = RAREZA_PROBABILIDAD.comun;
                probRaro = RAREZA_PROBABILIDAD.raro;
                probEpico = RAREZA_PROBABILIDAD.epico;
            }
            
            const rand = Math.random();
            if (rand < probComun) return 'comun';
            if (rand < probComun + probRaro) return 'raro';
            return 'epico';
        }

        // --- MAP LOGIC (7x7) ---
        // Indices calculados (Row * 7 + Col)
        // Centro (3,3) = 24
        const MAP_SLOTS = {
            1: [24], // Center
            2: [17, 25, 31, 23], // N(3,2)=17+? No: 2*7+3=17. E(3,4)=25. S(4,3)=31. W(3,2)? No row=3, col=2 -> 23. Correct. (N, E, S, W)
            3: [16, 18, 32, 30], // NW(2,2)=16. NE(2,4)=18. SE(4,4)=32. SW(4,2)=30. (NW, NE, SE, SW)
            4: [10, 39, 27, 21], // N2(1,3)=10. S2(5,3)=38? 5*7+3=38. Wait, my math. Row 5, col 3.
                // Let's verify.
                // Center 24 = (3,3).
                // N (-1 y) = (2,3) = 17.
                // S (+1 y) = (4,3) = 31.
                // E (+1 x) = (3,4) = 25.
                // W (-1 x) = (3,2) = 23.
                // NW (-1,-1) = (2,2) = 16.
                // NE (-1, 1) = (2,4) = 18.
                // SW (1, -1) = (4,2) = 30.
                // SE (1, 1) = (4,4) = 32.
                // L4 (Dist 2 Cardinal):
                // N2 (1,3) = 1*7+3 = 10.
                // S2 (5,3) = 5*7+3 = 38.
                // E2 (3,5) = 3*7+5 = 26.
                // W2 (3,1) = 3*7+1 = 22.
            5: [3, 45, 27, 21] // Dist 3 Cardinal.
                // N3 (0,3) = 3.
                // S3 (6,3) = 45.
                // E3 (3,6) = 27.
                // W3 (3,0) = 21.
        };
        // Fix L4 indices in constant
        const MAP_SLOTS_FIXED = {
            1: [24],
            2: [17, 25, 31, 23], // N, E, S, W
            3: [16, 18, 32, 30], // NW, NE, SE, SW
            4: [10, 26, 38, 22], // N, E, S, W
            5: [3, 27, 45, 21]   // N, E, S, W
        };

        function initMap() {
            mapGrid = new Array(49).fill(null);
            // Nivel 1 siempre fijo
            const sysName = 'Sistema_Tierra';
            const planetStates = { 'Planeta_Tierra_Base': { shops: 0, eventObjects: 0, eventPortals: 0, eventNegative: 0 } };
            mapGrid[24] = { systemName: sysName, level: 1, planetStates: planetStates };
            renderMap();
        }

        function updateMapForLevel(level) {
            if (level > 5) return;
            if (!MAP_SLOTS_FIXED[level]) return;

            const sistemas = shuffleArray(SISTEMAS_POR_NIVEL[level].sistemas);
            const slots = MAP_SLOTS_FIXED[level];

            // Nivel 5 solo usa 2 slots aleatorios de los 4 disponibles
            if (level === 5) {
                const pickedSlots = shuffleArray(slots).slice(0, 2);
                for(let i=0; i<2; i++) {
                    // Initialize planet states for specific tracking
                    const sysName = sistemas[i];
                    const planetas = SYSTEM_PLANET_RELATION[sysName] || [];
                    const planetStates = {};
                    planetas.forEach(p => {
                        planetStates[p] = { shops: 0, eventObjects: 0, eventPortals: 0, eventNegative: 0 };
                    });
                    
                    mapGrid[pickedSlots[i]] = { 
                        systemName: sysName, 
                        level: 5, 
                        planetStates: planetStates 
                    };
                }
            } else {
                // Niveles 2, 3, 4 llenan todos sus slots
                for(let i=0; i<slots.length; i++) {
                    if (sistemas[i]) {
                        const sysName = sistemas[i];
                        const planetas = SYSTEM_PLANET_RELATION[sysName] || [];
                        const planetStates = {};
                        planetas.forEach(p => {
                            planetStates[p] = { shops: 0, eventObjects: 0, eventPortals: 0, eventNegative: 0 };
                        });

                        mapGrid[slots[i]] = { 
                            systemName: sysName, 
                            level: level, 
                            planetStates: planetStates
                        };
                    }
                }
            }
            renderMap();
        }

        // --- CONFIGURACIÓN VISUAL DE SISTEMAS ---
        const SYSTEM_LAYOUTS_CONFIG = {
            // NIVEL 1
            'Sistema_Tierra': {
                nodes: [ { id: 'Planeta_Tierra_Base', x: 50, y: 50 } ],
                connections: [],
                exits: { N: 'Planeta_Tierra_Base', E: 'Planeta_Tierra_Base', S: 'Planeta_Tierra_Base', W: 'Planeta_Tierra_Base' }
            },

            // NIVEL 2
            'Sistema_Fuego': {
                nodes: [
                    { id: 'Planeta_Llamas', x: 50, y: 20 }, // Arriba
                    { id: 'Planeta_Chispa', x: 80, y: 60 }, // Der
                    { id: 'Planeta_Magma', x: 20, y: 60 }   // Izq
                ],
                connections: [['Planeta_Llamas','Planeta_Chispa'], ['Planeta_Chispa','Planeta_Magma'], ['Planeta_Magma','Planeta_Llamas']],
                exits: { N: 'Planeta_Llamas', E: 'Planeta_Chispa', S: 'Planeta_Chispa', W: 'Planeta_Magma' }
            },
            'Sistema_Viento': {
                nodes: [
                    { id: 'Planeta_Burbuja', x: 30, y: 40 }, // Izq Arriba
                    { id: 'Planeta_Torrnado', x: 70, y: 60 } // Der Abajo
                ],
                connections: [['Planeta_Burbuja', 'Planeta_Torrnado']],
                exits: { N: 'Planeta_Burbuja', E: 'Planeta_Torrnado', S: 'Planeta_Torrnado', W: 'Planeta_Burbuja' }
            },
            'Sistema_Tierra_Elemental': { // "sistema tierra" en imagen
                nodes: [
                    { id: 'Planeta_Roca', x: 70, y: 30 },    // Arriba Der
                    { id: 'Planeta_Botanico', x: 20, y: 40 },// Izq
                    { id: 'Planeta_Barro', x: 50, y: 80 }    // Abajo
                ],
                connections: [['Planeta_Roca','Planeta_Barro'], ['Planeta_Barro','Planeta_Botanico'], ['Planeta_Botanico','Planeta_Roca']],
                exits: { N: 'Planeta_Roca', E: 'Planeta_Roca', S: 'Planeta_Barro', W: 'Planeta_Botanico' }
            },
            'Sistema_Agua': {
                nodes: [
                    { id: 'Planeta_Olas', x: 40, y: 30 }, // Arriba Izq
                    { id: 'Planeta_Gota', x: 60, y: 70 }  // Abajo Der
                ],
                connections: [['Planeta_Olas', 'Planeta_Gota']],
                exits: { N: 'Planeta_Olas', E: 'Planeta_Olas', S: 'Planeta_Gota', W: 'Planeta_Olas' }
            },

            // NIVEL 3
            'Sistema_Prehistorico': {
                nodes: [
                    { id: 'Planeta_Hueso', x: 20, y: 25 },    // Arriba Izq
                    { id: 'Planeta_Fosil', x: 80, y: 25 },    // Arriba Der
                    { id: 'Planeta_HuevoDino', x: 50, y: 70 } // Abajo
                ],
                connections: [['Planeta_Hueso','Planeta_Fosil'], ['Planeta_Fosil','Planeta_HuevoDino'], ['Planeta_HuevoDino','Planeta_Hueso']],
                exits: { N: 'Planeta_Hueso', E: 'Planeta_Fosil', S: 'Planeta_HuevoDino', W: 'Planeta_Hueso' }
            },
            'Sistema_FarWest': {
                nodes: [
                    { id: 'Planeta_Dinamita', x: 50, y: 20 },    // Arriba
                    { id: 'Planeta_GorroCowboy', x: 80, y: 50 }, // Der
                    { id: 'Planeta_Barril', x: 70, y: 80 }, // Abajo Der
                    { id: 'Planeta_Rueda', x: 20, y: 60 }        // Izq
                ],
                connections: [['Planeta_Dinamita','Planeta_GorroCowboy'], ['Planeta_GorroCowboy','Planeta_Barril'], ['Planeta_Barril','Planeta_Rueda'], ['Planeta_Rueda','Planeta_Dinamita']],
                exits: { N: 'Planeta_Dinamita', E: 'Planeta_GorroCowboy', S: 'Planeta_Barril', W: 'Planeta_Rueda' }
            },
            'Sistema_Medieval': {
                nodes: [
                    { id: 'Planeta_Yelmo', x: 70, y: 30 },   // Arriba Der
                    { id: 'Planeta_Castillo', x: 50, y: 70 }, // Abajo
                    { id: 'Planeta_Cadenas', x: 20, y: 80 },  // Abajo Izq
                    { id: 'Planeta_Escudo', x: 20, y: 40 }    // Arriba Izq
                ],
                connections: [['Planeta_Yelmo','Planeta_Castillo'], ['Planeta_Castillo','Planeta_Cadenas'], ['Planeta_Cadenas','Planeta_Escudo'], ['Planeta_Escudo','Planeta_Yelmo']],
                exits: { N: 'Planeta_Yelmo', E: 'Planeta_Yelmo', S: 'Planeta_Castillo', W: 'Planeta_Cadenas' }
            },
            'Sistema_Futurista': {
                nodes: [
                    { id: 'Planeta_Neon', x: 40, y: 20 },     // Arriba
                    { id: 'Planeta_PlacaBase', x: 80, y: 40 }, // Der
                    { id: 'Planeta_Holograma', x: 50, y: 85 }  // Abajo
                ],
                connections: [['Planeta_Neon','Planeta_PlacaBase'], ['Planeta_PlacaBase','Planeta_Holograma'], ['Planeta_Holograma','Planeta_Neon']],
                exits: { N: 'Planeta_Neon', E: 'Planeta_PlacaBase', S: 'Planeta_Holograma', W: 'Planeta_Neon' }
            },

            // NIVEL 4
            'Sistema_Windows': {
                nodes: [
                    { id: 'Planeta_InternetExplorer', x: 50, y: 15 }, // Arriba "explorer"
                    { id: 'Planeta_Archivos', x: 80, y: 50 },         // Der "archivos"
                    { id: 'Planeta_MiPC', x: 50, y: 85 },             // Abajo "mi pc"
                    { id: 'Planeta_Papelera', x: 20, y: 50 }          // Izq "papelera"
                ],
                connections: [['Planeta_InternetExplorer','Planeta_Archivos'], ['Planeta_Archivos','Planeta_MiPC'], ['Planeta_MiPC','Planeta_Papelera'], ['Planeta_Papelera','Planeta_InternetExplorer']],
                exits: { N: 'Planeta_InternetExplorer', E: 'Planeta_Archivos', S: 'Planeta_MiPC', W: 'Planeta_Papelera' }
            },
            'Sistema_Deporte': {
                nodes: [
                    { id: 'Planeta_Tenis', x: 40, y: 15 },   // Arriba
                    { id: 'Planeta_Voley', x: 85, y: 20 },   // Arriba Der
                    { id: 'Planeta_Futbol', x: 85, y: 60 },  // Abajo Der
                    { id: 'Planeta_Beisbol', x: 50, y: 85 }, // Abajo
                    { id: 'Planeta_Basket', x: 15, y: 50 }   // Izq
                ],
                connections: [['Planeta_Tenis','Planeta_Voley'], ['Planeta_Voley','Planeta_Futbol'], ['Planeta_Futbol','Planeta_Beisbol'], ['Planeta_Beisbol','Planeta_Basket'], ['Planeta_Basket','Planeta_Tenis']],
                exits: { N: 'Planeta_Tenis', E: 'Planeta_Futbol', S: 'Planeta_Beisbol', W: 'Planeta_Basket' }
            },
            'Sistema_Pizza': {
                nodes: [
                    { id: 'Planeta_Cebolla', x: 20, y: 30 },   // Arriba Izq
                    { id: 'Planeta_Tomate', x: 70, y: 30 },    // Arriba Der
                    { id: 'Planeta_Champiñon', x: 50, y: 90 }, // Abajo
                    { id: 'Planeta_Pepperoni', x: 20, y: 80 }, // Abajo Izq
                    { id: 'Planeta_Queso', x: 50, y: 60 }      // Centro
                ],
                connections: [['Planeta_Cebolla','Planeta_Tomate'], ['Planeta_Tomate','Planeta_Queso'], ['Planeta_Queso','Planeta_Pepperoni'], ['Planeta_Pepperoni','Planeta_Cebolla'], ['Planeta_Queso', 'Planeta_Champiñon']],
                exits: { N: 'Planeta_Cebolla', E: 'Planeta_Tomate', S: 'Planeta_Champiñon', W: 'Planeta_Pepperoni' }
            },
            'Sistema_Chuche': {
                nodes: [
                    { id: 'Planeta_Gominola', x: 50, y: 20 }, // Arriba
                    { id: 'Planeta_Chicle', x: 85, y: 45 },   // Der
                    { id: 'Planeta_Piruleta', x: 80, y: 80 }, // Abajo Der
                    { id: 'Planeta_Nube', x: 20, y: 75 }      // Abajo Izq
                ],
                connections: [['Planeta_Gominola','Planeta_Chicle'], ['Planeta_Chicle','Planeta_Piruleta'], ['Planeta_Piruleta','Planeta_Nube'], ['Planeta_Nube','Planeta_Gominola']],
                exits: { N: 'Planeta_Gominola', E: 'Planeta_Chicle', S: 'Planeta_Piruleta', W: 'Planeta_Nube' }
            },

            // NIVEL 5
            'Sistema_Gemas': {
                nodes: [
                    { id: 'Planeta_Esmalte', x: 25, y: 20 },      // Arriba Izq
                    { id: 'Planeta_Lapislazuli', x: 75, y: 20 },  // Arriba Der
                    { id: 'Planeta_Topacio', x: 90, y: 50 },      // Der
                    { id: 'Planeta_Rubi', x: 50, y: 80 },         // Abajo
                    { id: 'Planeta_Diamante', x: 10, y: 50 }      // Izq
                ],
                connections: [['Planeta_Esmalte','Planeta_Lapislazuli'], ['Planeta_Lapislazuli','Planeta_Topacio'], ['Planeta_Topacio','Planeta_Rubi'], ['Planeta_Rubi','Planeta_Diamante'], ['Planeta_Diamante','Planeta_Esmalte']],
                exits: { N: 'Planeta_Lapislazuli', E: 'Planeta_Topacio', S: 'Planeta_Rubi', W: 'Planeta_Diamante' }
            },
            'Sistema_Geometria_Minimalista': {
                nodes: [
                    { id: 'Planeta_Poligono_6', x: 30, y: 20 }, // Arriba Izq (Hex)
                    { id: 'Planeta_Poligono_4', x: 70, y: 40 }, // Arriba Der (Cuadrado)
                    { id: 'Planeta_Poligono_3', x: 50, y: 80 }, // Abajo (Triangulo)
                    { id: 'Planeta_Poligono_5', x: 20, y: 70 }, // Abajo Izq (Pentagono)
                    { id: 'Planeta_Poligono_7', x: 85, y: 75 }  // Abajo Der (Octogono en imagen, es 7 o 8?)
                ],
                connections: [['Planeta_Poligono_6','Planeta_Poligono_4'], ['Planeta_Poligono_4','Planeta_Poligono_7'], ['Planeta_Poligono_7','Planeta_Poligono_3'], ['Planeta_Poligono_3','Planeta_Poligono_5'], ['Planeta_Poligono_5','Planeta_Poligono_6']],
                exits: { N: 'Planeta_Poligono_6', E: 'Planeta_Poligono_4', S: 'Planeta_Poligono_3', W: 'Planeta_Poligono_5' }
            }
        };

        function getSystemLayout(systemName) {
            // Si tenemos config manual, usarla
            if (SYSTEM_LAYOUTS_CONFIG[systemName]) {
                return SYSTEM_LAYOUTS_CONFIG[systemName];
            }
            
            // Fallback automático si falta alguno
            const planets = SYSTEM_PLANET_RELATION[systemName] || ['Unknown'];
            const count = planets.length;
            let nodes = [];
            
            // ... (Lógica de fallback simple anterior) ...
            const radius = 35;
            const centerX = 50;
            const centerY = 50;
            for(let i=0; i<count; i++) {
                const angle = (i / count) * 2 * Math.PI - (Math.PI/2);
                nodes.push({
                    id: planets[i],
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                });
            }
            
            return {
                nodes: nodes,
                connections: [], // No auto-connections
                exits: { N: nodes[0]?.id, E: nodes[1]?.id, S: nodes[nodes.length-1]?.id, W: nodes[nodes.length-1]?.id }
            };
        }

        function renderMap() {
            const gridEl = document.getElementById('visual-map');
            gridEl.innerHTML = '';

            for(let i=0; i<49; i++) {
                const cell = document.createElement('div');
                cell.className = 'map-cell';
                
                const data = mapGrid[i];
                if (data) {
                    cell.classList.add(`cell-lvl-${data.level}`);
                    
                    const layout = getSystemLayout(data.systemName);
                    const nodes = layout.nodes;
                    const connections = layout.connections;
                    const exits = layout.exits;
                    
                    // SVG Connections
                    let svgHTML = `<svg class="connections-svg" viewBox="0 0 100 100">`;
                    
                    // 1. External Connections (Salidas)
                    // Siempre conectamos al centro de los bordes (50,0), (100,50), (50,100), (0,50)
                    if (exits) {
                        const nNode = nodes.find(n => n.id === exits.N);
                        if(nNode) svgHTML += `<line x1="${nNode.x}" y1="${nNode.y}" x2="50" y2="0" class="connection-line" />`;
                        
                        const eNode = nodes.find(n => n.id === exits.E);
                        if(eNode) svgHTML += `<line x1="${eNode.x}" y1="${eNode.y}" x2="100" y2="50" class="connection-line" />`;
                        
                        const sNode = nodes.find(n => n.id === exits.S);
                        if(sNode) svgHTML += `<line x1="${sNode.x}" y1="${sNode.y}" x2="50" y2="100" class="connection-line" />`;
                        
                        const wNode = nodes.find(n => n.id === exits.W);
                        if(wNode) svgHTML += `<line x1="${wNode.x}" y1="${wNode.y}" x2="0" y2="50" class="connection-line" />`;
                    }
                    
                    // 2. Internal Connections
                    connections.forEach(pair => {
                         const p1 = nodes.find(n => n.id === pair[0]);
                         const p2 = nodes.find(n => n.id === pair[1]);
                         if (p1 && p2) {
                             svgHTML += `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" class="connection-line" />`;
                         }
                    });
                    
                    svgHTML += `</svg>`;
                    
                    // Planets Nodes
                    let nodesHTML = '';
                    nodes.forEach(p => {
                        const pState = data.planetStates && data.planetStates[p.id] ? data.planetStates[p.id] : { shops:0, eventObjects:0, eventPortals:0, eventNegative:0 };
                        
                        let badges = '';
                        if(pState.shops > 0) badges += `<div class="planet-badge badge-shop">${pState.shops}</div>`;
                        if(pState.eventObjects > 0) badges += `<div class="planet-badge badge-event">!</div>`;
                        if(pState.eventPortals > 0) badges += `<div class="planet-badge badge-portal">P</div>`;
                        if(pState.eventNegative > 0) badges += `<div class="planet-badge badge-danger">X</div>`;

                        nodesHTML += `
                            <div class="planet-node active-node" style="left: ${p.x}%; top: ${p.y}%;" title="${p.id}">
                                ${badges}
                            </div>
                        `;
                    });

                    cell.innerHTML = `
                        <div class="system-container">
                            ${data.systemDanger ? '<div class="system-danger-overlay"></div>' : ''}
                            ${svgHTML}
                            ${nodesHTML}
                            <div class="system-label-overlay">${data.systemName.replace('Sistema_', '').replace(/_/g, ' ')}</div>
                        </div>
                    `;
                }

                gridEl.appendChild(cell);
            }
        }

        // --- CORE FUNCTIONS ---

        function resetGame() {
            if(!confirm("¿Seguro que quieres reiniciar?")) return;
            nivelActual = 1;
            faseJuego = 'EXPANSION';
            turnosParaBigCrunch = 1;
            initMap(); // Reset map
            updateUIState();
            
            document.getElementById('map-output').innerHTML = "<p class='font-bold text-yellow-500 mb-1'>ESTADO</p>Nivel 1 Reiniciado.";
            document.getElementById('shop-locations-details').textContent = "Esperando generación...";
            document.getElementById('event-output').innerHTML = "<div class='text-center italic text-gray-500 my-auto'>Pulsa para generar los eventos...</div>";
            document.getElementById('shop-inventory-container').innerHTML = '<div class="col-span-full text-center py-8 text-gray-500 border border-dashed border-gray-700 rounded-xl text-xs">Genera la tienda para ver objetos.</div>';
        }

        function updateUIState() {
            const levelEl = document.getElementById('current-level');
            const phaseEl = document.getElementById('phase-label');
            const container = document.getElementById('level-container');
            const btn = document.getElementById('btn-next-level');

            levelEl.textContent = nivelActual;
            container.className = 'card p-6 mb-6 rounded-2xl text-center border-t-4 relative overflow-hidden'; // Reset
            levelEl.className = 'text-7xl font-black text-white';
            
            if (faseJuego === 'EXPANSION') {
                phaseEl.textContent = 'FASE: EXPANSIÓN UNIVERSAL';
                phaseEl.className = 'text-sm font-bold tracking-widest text-blue-400 uppercase mb-2 block';
                container.classList.add('border-[#1f6feb]');
                btn.innerHTML = '<i data-lucide="arrow-right-circle" class="w-4 h-4"></i> SIGUIENTE TURNO';
                btn.className = "btn btn-primary py-2 px-4 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2";
            } else if (faseJuego === 'CUENTA_ATRAS') {
                phaseEl.textContent = '⚠️ ALERTA: COLAPSO';
                phaseEl.className = 'text-sm font-bold tracking-widest text-orange-500 uppercase mb-2 block animate-pulse';
                container.classList.add('border-orange-500');
                levelEl.className = 'text-7xl font-black text-orange-500';
                const turnText = turnosParaBigCrunch === 1 ? "1 TURNO" : `${turnosParaBigCrunch} TURNOS`;
                btn.innerHTML = `<i data-lucide="timer" class="w-4 h-4"></i> CRUNCH EN ${turnText}`;
                btn.className = "btn btn-danger py-2 px-4 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2 bg-orange-600 border-orange-500";
            } else if (faseJuego === 'BIG_CRUNCH') {
                phaseEl.textContent = '🚨 BIG CRUNCH 🚨';
                phaseEl.className = 'text-sm font-bold tracking-widest text-red-500 uppercase mb-2 block';
                container.classList.add('crunch-mode', 'border-red-500'); 
                levelEl.className = 'text-7xl font-black text-red-500';
                btn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i> DESTRUIR NIVEL';
                btn.className = "btn btn-danger py-2 px-4 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2";
            }
            lucide.createIcons();
        }

        function handleTurnCycle() {
            const mapOutput = document.getElementById('map-output');

            if (faseJuego === 'EXPANSION') {
                if (nivelActual < 5) {
                    nivelActual++;
                    updateMapForLevel(nivelActual); // ACTUALIZAR VISUAL
                    
                    let msg = `Nivel ${nivelActual} Desbloqueado.`;
                    if (nivelActual === 5) {
                        faseJuego = 'CUENTA_ATRAS';
                        msg += " ¡BIG CRUNCH INICIADO!";
                    }
                    mapOutput.innerHTML = `<p class="font-bold text-green-400 mb-1">EXPANSIÓN</p>${msg}`;
                    updateUIState();
                    return;
                }
            }

            if (faseJuego === 'CUENTA_ATRAS') {
                if (turnosParaBigCrunch > 0) {
                    mapOutput.innerHTML = `<p class="font-bold text-orange-500 mb-1">CUENTA ATRÁS</p>Queda ${turnosParaBigCrunch} turno.`;
                    turnosParaBigCrunch--;
                    updateUIState();
                    return;
                } else {
                    faseJuego = 'BIG_CRUNCH';
                    mapOutput.innerHTML = `<p class="font-bold text-red-500 mb-1">¡IMPACTO!</p>El Nivel 5 ha sido destruido.`;
                    
                    // Destruir Nivel 5 del mapa visual
                    mapGrid.forEach((cell, idx) => { if(cell && cell.level === 5) mapGrid[idx] = null; });
                    renderMap();
                    
                    nivelActual = 4;
                    updateUIState();
                    return;
                }
            }

            if (faseJuego === 'BIG_CRUNCH') {
                if (nivelActual > 1) {
                    // Destruir nivel actual
                    mapGrid.forEach((cell, idx) => { if(cell && cell.level === nivelActual) mapGrid[idx] = null; });
                    
                    mapOutput.innerHTML = `<p class="font-bold text-red-500 mb-1">COLAPSO</p>Nivel ${nivelActual} consumido.`;
                    nivelActual--;
                    
                    if (nivelActual === 1) {
                         mapOutput.innerHTML += "<br><span class='text-red-300'>¡Vuelta al Nivel 1!</span>";
                    }
                    renderMap();
                    updateUIState();
                } else {
                    mapOutput.innerHTML = "Fin del Universo.";
                }
            }
        }

        function generateShopLocations() {
            const detailOut = document.getElementById('shop-locations-details');
            
            // Limpiar shops previos (en planetStates)
            mapGrid.forEach(c => { 
                if(c && c.planetStates) {
                    Object.values(c.planetStates).forEach(st => st.shops = 0);
                }
            });

            let planetasActivos = [];
            for (let n = 2; n <= nivelActual; n++) {
                if (SISTEMAS_POR_NIVEL[n]) {
                    planetasActivos = planetasActivos.concat(SISTEMAS_POR_NIVEL[n].planetas);
                }
            }

            if (planetasActivos.length === 0) {
                detailOut.textContent = "Nivel 1: Sin tiendas.";
                renderMap();
                return;
            }

            let numSistemas = 0;
            mapGrid.forEach(c => { if(c && c.level > 1) numSistemas++; }); 

            const minShops = Math.max(1, Math.floor(numSistemas / 2));
            const shuffledPlanets = shuffleArray([...planetasActivos]);
            const selectedPlanets = shuffledPlanets.slice(0, minShops);

            // Asignar al mapa
            let locationListHTML = '<ul class="space-y-1">';
            
            selectedPlanets.forEach(planet => {
                const system = PLANET_TO_SYSTEM_MAP[planet];
                // Encontrar celda del sistema
                const cellIndex = mapGrid.findIndex(c => c && c.systemName === system);
                if (cellIndex !== -1 && mapGrid[cellIndex].planetStates) {
                    // Asignar tienda al planeta específico
                    if (!mapGrid[cellIndex].planetStates[planet]) {
                         mapGrid[cellIndex].planetStates[planet] = { shops: 0, eventObjects: 0, eventPortals: 0, eventNegative: 0 };
                    }
                    mapGrid[cellIndex].planetStates[planet].shops++;
                    locationListHTML += `<li><span class="text-blue-300">${planet}</span> <span class="text-[10px] text-gray-500">(${system.replace('Sistema_', '')})</span></li>`;
                }
            });
            locationListHTML += '</ul>';

            detailOut.innerHTML = locationListHTML;
            renderMap(); 
        }

        function generateItem(tipo, nivel, forcedRarity = null) {
            const itemsValidos = ITEMS_POR_TIPO[tipo].filter(item => item.niveles.includes(nivel));
            if (itemsValidos.length === 0) return null;
            const rareza = generateRareza(forcedRarity, nivel);
            let candidatos = itemsValidos.filter(i => i.rareza === rareza);
            if (candidatos.length === 0) candidatos = itemsValidos; 
            const itemElegido = getRandomElement(candidatos);
            if (!itemElegido) return null;
            return { ...itemElegido, tipoObjeto: tipo }; 
        }

        function createItemCardHTML(item, compact = false) {
            if (!item) return '';
            const rarityClass = `rarity-${item.rareza}`;
            let icon = 'box';
            let colorText = 'text-gray-300';
            if(item.tipoObjeto === 'Vida') { icon = 'heart'; colorText = 'text-red-400'; }
            if(item.tipoObjeto === 'Combustible') { icon = 'flame'; colorText = 'text-orange-400'; }
            if(item.tipoObjeto === 'Potencia') { icon = 'zap'; colorText = 'text-yellow-400'; }
            if(item.tipoObjeto === 'Habilidad') { icon = 'star'; colorText = 'text-cyan-400'; }
            if(item.tipoObjeto === 'Especial') { icon = 'crown'; colorText = 'text-purple-400'; }

            let details = "";
            if (item.potenciaValor) details += `<span class="text-xs bg-gray-700 px-2 py-1 rounded text-white">Potencia: ${item.potenciaValor}</span>`;
            if (item.desc) details += `<p class="text-xs text-gray-400 mt-2 italic border-t border-gray-700 pt-1">"${item.desc}"</p>`;

            if (compact) {
                let compactDetails = "";
                if (item.potenciaValor) compactDetails += `<div class="mt-1"><span class="text-[10px] bg-gray-800 px-1.5 py-0.5 rounded text-yellow-200 border border-gray-700 inline-block font-mono">⚡ Potencia: ${item.potenciaValor}</span></div>`;
                if (item.desc) compactDetails += `<p class="text-[10px] text-gray-400 italic mt-1">"${item.desc}"</p>`;

                return `
                    <div class="event-item-preview p-3 bg-[#0b0e14] border border-gray-700 rounded-xl flex flex-col gap-1">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${icon}" class="w-4 h-4 ${colorText}"></i>
                                <span class="text-xs font-bold text-white">${item.id.replace(/_/g, ' ')}</span>
                            </div>
                            <span class="rarity-tag ${rarityClass} scale-90 origin-right">${item.rareza}</span>
                        </div>
                        ${compactDetails}
                    </div>
                `;
            }

            return `
                <div class="p-3 bg-[#0b0e14] border border-gray-700 rounded-xl flex flex-col gap-2 hover:border-gray-500 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${icon}" class="w-4 h-4 ${colorText}"></i>
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">${item.tipoObjeto}</span>
                        </div>
                        <span class="rarity-tag ${rarityClass}">${item.rareza}</span>
                    </div>
                    <div class="font-bold text-xs sm:text-sm text-white leading-tight">
                        ${item.id.replace(/_/g, ' ')}
                    </div>
                    <div class="mt-1">
                        ${details}
                    </div>
                </div>
            `;
        }

        function generateShopInventory() {
            const shopLevel = parseInt(document.getElementById('shop-level-select').value);
            const container = document.getElementById('shop-inventory-container');
            if (isNaN(shopLevel)) {
                container.innerHTML = '<div class="col-span-full text-center text-red-400 font-bold text-sm">¡Selecciona un nivel!</div>';
                return;
            }
            const tiposDisponibles = ['Potencia', 'Habilidad', 'Vida', 'Combustible'];
            let itemsData = [];
            for(let i=0; i<4; i++) {
                const tipoAleatorio = getRandomElement(tiposDisponibles);
                const item = generateItem(tipoAleatorio, shopLevel);
                itemsData.push(item);
            }
            if (shopLevel === 5) {
                const hasEpic = itemsData.some(i => i && i.rareza === 'epico');
                if (!hasEpic) {
                    const indexToReplace = Math.floor(Math.random() * 4);
                    const tipoForce = getRandomElement(tiposDisponibles); 
                    itemsData[indexToReplace] = generateItem(tipoForce, shopLevel, 'epico');
                }
            }
            if (Math.random() < 0.10) {
                 const especial = generateItem('Especial', shopLevel);
                 if(especial) itemsData.push(especial); 
            }
            container.innerHTML = itemsData.map(item => createItemCardHTML(item)).join('');
            lucide.createIcons();
        }

        function generateEvent() {
            const out = document.getElementById('event-output');
            out.innerHTML = ''; 
            
            // Reset previous event markers
            mapGrid.forEach(c => { 
                if(c) {
                    c.systemDanger = false; // Reset flag
                    if (c.planetStates) {
                        Object.values(c.planetStates).forEach(st => {
                            st.eventObjects = 0; 
                            st.eventPortals = 0; 
                            st.eventNegative = 0; 
                        });
                    }
                }
            });
            
            let sistemasActivos = [];
            let planetasActivos = [];
            // Usar mapGrid para determinar que esta activo realmente
            mapGrid.forEach(cell => {
                if (cell) {
                     const planets = SYSTEM_PLANET_RELATION[cell.systemName];
                     if (planets) planetasActivos = planetasActivos.concat(planets);
                     sistemasActivos.push(cell.systemName);
                }
            });

            // Filtrar Nivel 1
            if (nivelActual === 1) {
                out.innerHTML = "<p class='text-gray-400 text-center text-sm'>No hay eventos en el Nivel 1.</p>";
                renderMap();
                return;
            }

            // 1. POSITIVO
            let positiveEventHTML = '';
            const isPortal = Math.random() < 0.25; 
            if (isPortal) {
                const targets = shuffleArray(planetasActivos).slice(0, Math.random() < 0.5 ? 2 : 3);
                
                // Mark Portals on Map
                targets.forEach(target => {
                    const sysName = PLANET_TO_SYSTEM_MAP[target];
                    const cellIndex = mapGrid.findIndex(c => c && c.systemName === sysName);
                    if (cellIndex !== -1 && mapGrid[cellIndex].planetStates) {
                        if (!mapGrid[cellIndex].planetStates[target]) mapGrid[cellIndex].planetStates[target] = {shops:0, eventObjects:0, eventPortals:0, eventNegative:0};
                        mapGrid[cellIndex].planetStates[target].eventPortals = 1;
                    }
                });

                positiveEventHTML = `
                    <div class="event-card event-positive">
                        <div class="event-section-title text-green-400">
                            <i data-lucide="door-open" class="w-4 h-4"></i> PORTAL
                        </div>
                        <p class="text-xs text-green-300 font-mono font-bold">${targets.join(' <-> ')}</p>
                    </div>
                `;
            } else {
                const targetPlanet = getRandomElement(planetasActivos);
                const randomObj = getRandomElement(EVENTO_OBJETOS_POOL);
                const cardHTML = createItemCardHTML(randomObj, true); // Compact
                
                // Update Map Grid for Event
                const sysName = PLANET_TO_SYSTEM_MAP[targetPlanet];
                const cellIndex = mapGrid.findIndex(c => c && c.systemName === sysName);
                if (cellIndex !== -1 && mapGrid[cellIndex].planetStates) {
                    if (!mapGrid[cellIndex].planetStates[targetPlanet]) mapGrid[cellIndex].planetStates[targetPlanet] = {shops:0, eventObjects:0, eventPortals:0, eventNegative:0};
                    mapGrid[cellIndex].planetStates[targetPlanet].eventObjects++;
                }

                positiveEventHTML = `
                    <div class="event-card event-positive">
                        <div class="event-section-title text-green-400">
                            <i data-lucide="gift" class="w-4 h-4"></i> OBJETO
                        </div>
                        <p class="text-xs text-gray-300 mb-1">En <strong class="text-white">${targetPlanet}</strong>:</p>
                        ${cardHTML}
                    </div>
                `;
            }

            // 2. NEGATIVOS
            let negativeEventsHTML = '';
            const eventosNegativosPool = shuffleArray(EVENTOS_NEGATIVOS);
            for(let i=0; i<2; i++) {
                const ev = eventosNegativosPool[i];
                let titulo = ev.replace(/_/g, ' ');
                let desc = "";
                let icon = "alert-octagon";
                
                // Targets
                let targetSysName = null;
                let targetPlanetName = null; 

                if (ev === 'Evento_Explosion_Sistema') {
                    const target = getRandomElement(sistemasActivos); // system
                    targetSysName = target;
                    desc = `Sistema <strong class="text-white">${target.replace('Sistema_','')}</strong> explotará.`;
                    icon = "flame";
                } else if (ev === 'Evento_Sistema_Infectado') {
                    const target = getRandomElement(sistemasActivos); // system
                    targetSysName = target;
                    desc = `Sistema <strong class="text-white">${target.replace('Sistema_','')}</strong> infectado (Daño 1/turno).`;
                    icon = "skull";
                } else if (ev === 'Evento_Basura Espacial') {
                    const target = getRandomElement(planetasActivos); // planet
                    targetSysName = PLANET_TO_SYSTEM_MAP[target];
                    targetPlanetName = target;
                    desc = `Basura en <strong class="text-white">${target}</strong> (Daño 1).`;
                    icon = "satellite";
                } else { 
                    const target = getRandomElement(planetasActivos); // planet
                    targetSysName = PLANET_TO_SYSTEM_MAP[target];
                    targetPlanetName = target;
                    desc = `Rebelión en <strong class="text-white">${target}</strong> (Daño 1).`;
                    icon = "shield-alert";
                }

                // Update Map Grid for Negative Event
                if (targetSysName) {
                    const cellIndex = mapGrid.findIndex(c => c && c.systemName === targetSysName);
                    if (cellIndex !== -1 && mapGrid[cellIndex].planetStates) {
                        // Si es evento de sistema, marcar LA CELDA ENTERA
                        if (ev === 'Evento_Explosion_Sistema' || ev === 'Evento_Sistema_Infectado') {
                             mapGrid[cellIndex].systemDanger = true; // Nueva bandera
                        } else {
                            // Evento de un solo planeta
                            if (targetPlanetName) {
                                if (!mapGrid[cellIndex].planetStates[targetPlanetName]) mapGrid[cellIndex].planetStates[targetPlanetName] = {shops:0, eventObjects:0, eventPortals:0, eventNegative:0};
                                mapGrid[cellIndex].planetStates[targetPlanetName].eventNegative++;
                            }
                        }
                    }
                }

                negativeEventsHTML += `
                    <div class="event-card event-negative">
                        <div class="event-section-title text-red-400">
                            <i data-lucide="${icon}" class="w-4 h-4"></i> ${titulo}
                        </div>
                        <p class="text-xs text-gray-300 leading-relaxed">${desc}</p>
                    </div>
                `;
            }

            out.innerHTML = positiveEventHTML + negativeEventsHTML;
            renderMap(); // Re-render map to show event badges
            lucide.createIcons();
        }

        // INIT
        window.onload = () => {
            initMap();
            updateUIState();
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // Detectar si estamos en GitHub Pages (/docs) o raíz
                    const swPath = window.location.pathname.includes('/docs') 
                        ? '/docs/service-worker.js' 
                        : '/service-worker.js';
                    
                    navigator.serviceWorker.register(swPath)
                        .then((registration) => {
                            console.log('SW registrado:', registration.scope);
                        })
                        .catch((error) => {
                            console.log('SW falló:', error);
                        });
                });
            }
        };

    </script>
</body>
</html>
