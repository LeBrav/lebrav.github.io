<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Big Crunch Assistant App</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Asistente de Tablero para el juego de mesa Big Crunch">
    <meta name="theme-color" content="#1f6feb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Big Crunch">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons (temporal - puedes crear iconos reales despu칠s) -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* TEMA ESPACIAL OSCURO MEJORADO */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0e14; /* Fondo muy oscuro */
            background-image: radial-gradient(circle at 50% 0%, #1c2333 0%, #0b0e14 70%);
            color: #c9d1d9;
        }
        
        h1, h2, .font-tech {
            font-family: 'Orbitron', sans-serif;
        }

        /* TARJETAS CON EFECTO DE CRISTAL/PROFUNIDAD */
        .card {
            background-color: rgba(22, 27, 34, 0.95);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #30363d;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            border-color: #58a6ff;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
        }

        /* BOTONES PERSONALIZADOS */
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1f6feb 0%, #1a56db 100%);
            border: 1px solid #388bfd;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #388bfd 0%, #1f6feb 100%);
            box-shadow: 0 0 15px rgba(56, 139, 253, 0.4);
        }

        .btn-secondary {
            background-color: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background-color: #30363d;
            border-color: #8b949e;
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #da3633 0%, #b62324 100%);
            border: 1px solid #f85149;
        }
        .btn-danger:hover {
            box-shadow: 0 0 15px rgba(218, 54, 51, 0.4);
        }

        /* CAJAS DE TEXTO/RESULTADOS */
        .output-box {
            background-color: #0d1117;
            border: 1px solid #30363d;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        /* OBJETIVO 15MW */
        .goal-display {
            background: linear-gradient(90deg, #2e1065 0%, #000000 100%);
            border: 2px solid #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
            text-shadow: 0 0 10px #a855f7;
        }

        /* RAREZAS DE ITEMS (EST칄TICA) */
        .rarity-tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
            margin-left: auto;
        }
        .rarity-comun {
            background-color: #30363d;
            color: #8b949e; /* Gris */
            border: 1px solid #6e7681;
        }
        .rarity-raro {
            background-color: #0c2d6b; /* Azul oscuro fondo */
            color: #58a6ff; /* Azul brillante texto */
            border: 1px solid #1f6feb;
        }
        .rarity-epico {
            background-color: #2e1a4d; /* Lila oscuro fondo */
            color: #d2a8ff; /* Lila brillante texto */
            border: 1px solid #bc8cff;
            box-shadow: 0 0 5px rgba(188, 140, 255, 0.2);
        }
        .rarity-legendaria {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); /* Amarillo oro */
            color: #78350f; /* Marr칩n oscuro para contraste */
            border: 2px solid #fcd34d;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.6), 0 0 20px rgba(251, 191, 36, 0.3);
            font-weight: 900;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            animation: legendariaGlow 2s ease-in-out infinite;
        }
        @keyframes legendariaGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.6), 0 0 20px rgba(251, 191, 36, 0.3); }
            50% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.8), 0 0 30px rgba(251, 191, 36, 0.5); }
        }

        /* ANIMACI칍N BIG CRUNCH */
        @keyframes crunchPulse {
            0% { border-color: #da3633; box-shadow: 0 0 0 0 rgba(218, 54, 51, 0.4); }
            50% { border-color: #f85149; box-shadow: 0 0 20px 5px rgba(218, 54, 51, 0.2); }
            100% { border-color: #da3633; box-shadow: 0 0 0 0 rgba(218, 54, 51, 0.4); }
        }
        .crunch-mode {
            animation: crunchPulse 2s infinite;
        }

        /* Estilos espec칤ficos para eventos */
        .event-section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .event-card {
            border-left-width: 4px;
            padding: 0.75rem;
            background: rgba(0,0,0,0.3);
            border-radius: 0 0.5rem 0.5rem 0;
            margin-bottom: 0.75rem;
        }
        
        .event-positive {
            border-left-color: #3fb950; /* Verde */
            background: linear-gradient(90deg, rgba(63, 185, 80, 0.1) 0%, transparent 100%);
        }
        
        .event-negative {
            border-left-color: #da3633; /* Rojo */
            background: linear-gradient(90deg, rgba(218, 54, 51, 0.1) 0%, transparent 100%);
        }

        /* Item dentro de evento */
        .event-item-preview {
            transform: scale(0.95);
            transform-origin: left top;
            margin-top: 0.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 300px;
        }
        
        /* MAPA VISUAL GRID MEJORADO - DIN츼MICO */
        .map-grid {
            display: grid;
            gap: 4px; /* Peque침o espacio visual entre cartas */
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 600px; /* Un poco m치s grande para ver detalles */
            margin: 0 auto;
            background-color: #05070a;
            padding: 4px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        /* Din치micamente se ajustar치 grid-template-columns v칤a JS */
        
        .map-cell {
            background-color: rgba(22, 27, 34, 0.8);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 2px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        /* Fondos por nivel sutiles */
        .cell-lvl-1 { background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0) 80%); border-color: rgba(255,255,255,0.2); }
        .cell-lvl-2 { background: radial-gradient(circle, rgba(31, 111, 235, 0.15) 0%, rgba(0,0,0,0) 80%); border-color: rgba(31, 111, 235, 0.3); }
        .cell-lvl-3 { background: radial-gradient(circle, rgba(46, 160, 67, 0.15) 0%, rgba(0,0,0,0) 80%); border-color: rgba(46, 160, 67, 0.3); }
        .cell-lvl-4 { background: radial-gradient(circle, rgba(210, 153, 34, 0.15) 0%, rgba(0,0,0,0) 80%); border-color: rgba(210, 153, 34, 0.3); }
        .cell-lvl-5 { background: radial-gradient(circle, rgba(219, 109, 40, 0.15) 0%, rgba(0,0,0,0) 80%); border-color: rgba(219, 109, 40, 0.3); }

        /* Sistema Planetario Interno */
        .system-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .planet-node {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #1f2937; /* Default */
            border: 2px solid #4b5563;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 4px rgba(0,0,0,0.8);
            transition: transform 0.2s;
        }
        .planet-node:hover {
            transform: translate(-50%, -50%) scale(1.5);
            z-index: 20;
            cursor: help;
        }

        /* Colores de Planetas seg칰n el sistema (opcional, por ahora gen칠ricos con borde blanco) */
        .planet-node.active-node {
            background-color: #f0f6fc;
            border-color: #8b949e;
        }

        /* L칤neas de conexi칩n SVG */
        .connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .connection-line {
            stroke: #ef4444; /* ROJO como en las cartas */
            stroke-width: 1.5px;
            opacity: 0.6;
        }

        .system-danger-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(239, 68, 68, 0.15); /* Mas transparente */
            border: 3px solid #ef4444;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            animation: pulseExplosion 1s infinite;
        }
        .system-danger-overlay::after {
            content: "游눤";
            font-size: 2rem; /* Mas peque침o */
            opacity: 0.6;    /* Mas transparente */
            filter: drop-shadow(0 0 5px red);
        }
        
        .system-infected-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(239, 68, 68, 0.15); /* Rojo transparente (igual que explosion) */
            border: 3px solid #ef4444; /* Rojo */
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            animation: pulseInfected 2s infinite;
        }
        .system-infected-overlay::after {
            content: "驕勇";
            font-size: 2rem; 
            opacity: 0.6;
            filter: drop-shadow(0 0 5px red);
        }
        @keyframes pulseInfected {
            0% { background-color: rgba(239, 68, 68, 0.1); border-color: #ef4444; }
            50% { background-color: rgba(239, 68, 68, 0.25); border-color: #f87171; }
            100% { background-color: rgba(239, 68, 68, 0.1); border-color: #ef4444; }
        }

        @keyframes pulseExplosion {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; background-color: rgba(239, 68, 68, 0.5); }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* Etiquetas flotantes (Badges) sobre planetas */
        .planet-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 8px;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            z-index: 30;
            border: 1px solid white;
            box-shadow: 0 0 2px black;
        }
        .badge-shop { background-color: #a371f7; }
        .badge-event { background-color: #3fb950; }
        .badge-portal { background-color: #0ea5e9; top: auto; bottom: -8px; }
        .badge-danger { background-color: #ef4444; bottom: -8px; right: auto; left: -8px; }
        .badge-key { 
            background-color: #eab308; /* Yellow */
            color: black; 
            border: 1px solid #fef08a; 
            width: 16px; height: 16px; 
            font-size: 9px;
            top: auto; bottom: -8px; right: 50%; transform: translateX(50%);
            box-shadow: 0 0 8px rgba(234, 179, 8, 0.8);
            animation: pulseKey 1.5s infinite;
            z-index: 45;
            display: flex; align-items: center; justify-content: center;
        }
        /* KEY RING (ANILLA) */
        .badge-key-ring {
            width: 18px; height: 18px;
            border-radius: 50%;
            border: 3px solid #eab308; /* Anillo grueso */
            background: transparent;
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.9);
        }
        /* KEY TIP (PUNTA) */
        .badge-key-tip {
            width: 10px; height: 18px;
            border-radius: 2px;
            background: #eab308;
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 50% 80%, 0% 100%); /* Forma dentada simple */
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.9);
        }

        @keyframes pulseKey {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); transform: translateX(50%) scale(1); }
            70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); transform: translateX(50%) scale(1.2); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); transform: translateX(50%) scale(1); }
        }

        /* BOSS BADGES */
        .badge-boss {
            width: 16px;
            height: 16px;
            font-size: 10px;
            z-index: 40;
            border: 1px solid white;
            animation: pulseBoss 1.5s infinite;
            box-shadow: 0 0 5px rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .badge-boss-stellar { background: #fbbf24; color: black; top: -12px; left: 50%; transform: translateX(-50%); }
        .badge-boss-dark { background: #581c87; color: white; bottom: -12px; left: 50%; transform: translateX(-50%); }
        
        @keyframes pulseBoss { 
            0% { transform: translateX(-50%) scale(1); box-shadow: 0 0 5px rgba(255,255,255,0.5); } 
            50% { transform: translateX(-50%) scale(1.2); box-shadow: 0 0 15px rgba(255,255,255,0.8); } 
            100% { transform: translateX(-50%) scale(1); box-shadow: 0 0 5px rgba(255,255,255,0.5); } 
        }

        .system-label-overlay {
            position: absolute;
            bottom: 2px;
            left: 2px;
            font-size: 0.4rem;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
            text-transform: uppercase;
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body class="p-2 sm:p-6 min-h-screen">

    <!-- PANTALLA DE INICIO / SELECCI칍N DE PERSONAJES -->
    <div id="setup-screen" class="max-w-4xl mx-auto mt-10">
        <div class="text-center mb-10">
            <h1 class="text-5xl sm:text-7xl font-black text-[#ffcc00] tracking-tight mb-4" style="text-shadow: 0 0 30px rgba(255, 204, 0, 0.3);">
                BIG CRUNCH
            </h1>
            <p class="text-xl text-gray-400 font-tech uppercase tracking-widest">Configuraci칩n de Misi칩n</p>
        </div>

        <div class="card p-8 rounded-3xl border-2 border-gray-700 bg-opacity-95">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">SELECCIONA TRIPULACI칍N</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <!-- Explorador (Verde) -->
                <button id="btn-role-explorador" onclick="toggleRole('EXPLORADOR')" class="role-btn group relative p-6 rounded-xl border-2 border-gray-700 hover:border-green-500 bg-[#0d1117] transition-all duration-300 flex flex-col items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-green-900/30 flex items-center justify-center border-2 border-green-500/50 group-hover:border-green-400 group-hover:shadow-[0_0_20px_rgba(74,222,128,0.4)] transition-all">
                        <i data-lucide="compass" class="w-8 h-8 text-green-400"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-green-400 text-lg">EXPLORADOR</h3>
                        <div class="text-xs text-gray-500 mt-1">4 Movimientos</div>
                    </div>
                    <div class="absolute top-4 right-4 w-6 h-6 rounded-full border border-gray-600 bg-gray-800 flex items-center justify-center check-indicator">
                        <i data-lucide="check" class="w-4 h-4 text-white opacity-0 transition-opacity"></i>
                    </div>
                </button>

                <!-- Comerciante (Amarillo) -->
                <button id="btn-role-comerciante" onclick="toggleRole('COMERCIANTE')" class="role-btn group relative p-6 rounded-xl border-2 border-gray-700 hover:border-yellow-500 bg-[#0d1117] transition-all duration-300 flex flex-col items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-yellow-900/30 flex items-center justify-center border-2 border-yellow-500/50 group-hover:border-yellow-400 group-hover:shadow-[0_0_20px_rgba(250,204,21,0.4)] transition-all">
                        <i data-lucide="shopping-bag" class="w-8 h-8 text-yellow-400"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-yellow-400 text-lg">COMERCIANTE</h3>
                        <div class="text-xs text-gray-500 mt-1">2 Objetos Tienda</div>
                    </div>
                    <div class="absolute top-4 right-4 w-6 h-6 rounded-full border border-gray-600 bg-gray-800 flex items-center justify-center check-indicator">
                        <i data-lucide="check" class="w-4 h-4 text-white opacity-0 transition-opacity"></i>
                    </div>
                </button>

                <!-- Ingeniero (Cyan) -->
                <button id="btn-role-ingeniero" onclick="toggleRole('INGENIERO')" class="role-btn group relative p-6 rounded-xl border-2 border-gray-700 hover:border-cyan-500 bg-[#0d1117] transition-all duration-300 flex flex-col items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-cyan-900/30 flex items-center justify-center border-2 border-cyan-500/50 group-hover:border-cyan-400 group-hover:shadow-[0_0_20px_rgba(34,211,238,0.4)] transition-all">
                        <i data-lucide="wrench" class="w-8 h-8 text-cyan-400"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-cyan-400 text-lg">INGENIERO</h3>
                        <div class="text-xs text-gray-500 mt-1">Support & Pasiva</div>
                    </div>
                    <div class="absolute top-4 right-4 w-6 h-6 rounded-full border border-gray-600 bg-gray-800 flex items-center justify-center check-indicator">
                        <i data-lucide="check" class="w-4 h-4 text-white opacity-0 transition-opacity"></i>
                    </div>
                </button>

                <!-- Mensajero (Lila) -->
                <button id="btn-role-mensajero" onclick="toggleRole('MENSAJERO')" class="role-btn group relative p-6 rounded-xl border-2 border-gray-700 hover:border-purple-500 bg-[#0d1117] transition-all duration-300 flex flex-col items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-purple-900/30 flex items-center justify-center border-2 border-purple-500/50 group-hover:border-purple-400 group-hover:shadow-[0_0_20px_rgba(192,132,252,0.4)] transition-all">
                        <i data-lucide="send" class="w-8 h-8 text-purple-400"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-purple-400 text-lg">MENSAJERO</h3>
                        <div class="text-xs text-gray-500 mt-1">Env칤os Remotos</div>
                    </div>
                    <div class="absolute top-4 right-4 w-6 h-6 rounded-full border border-gray-600 bg-gray-800 flex items-center justify-center check-indicator">
                        <i data-lucide="check" class="w-4 h-4 text-white opacity-0 transition-opacity"></i>
                    </div>
                </button>
            </div>

            <div class="flex justify-center">
                <button id="btn-start-game" onclick="startGame()" disabled class="btn btn-secondary py-4 px-12 rounded-xl font-black text-xl tracking-widest opacity-50 cursor-not-allowed transition-all">
                    INICIAR MISI칍N
                </button>
            </div>
            <p id="player-count-label" class="text-center text-gray-500 mt-4 text-sm">Selecciona al menos 1 tripulante</p>
        </div>
        
        <style>
            .role-selected { background-color: rgba(255,255,255,0.05); }
            .role-selected .check-indicator { background-color: #1f6feb; border-color: #1f6feb; }
            .role-selected .check-indicator i { opacity: 1; }
            /* Colores espec칤ficos para selecci칩n */
            #btn-role-explorador.role-selected { border-color: #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.2); }
            #btn-role-comerciante.role-selected { border-color: #eab308; box-shadow: 0 0 15px rgba(234, 179, 8, 0.2); }
            #btn-role-ingeniero.role-selected { border-color: #06b6d4; box-shadow: 0 0 15px rgba(6, 182, 212, 0.2); }
            #btn-role-mensajero.role-selected { border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); }
        </style>
    </div>

    <!-- JUEGO PRINCIPAL (Oculto al inicio) -->
    <div id="game-app" class="max-w-6xl mx-auto hidden">
        
        <!-- Header con Reset y Objetivo -->
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 border-b border-gray-700 pb-6 gap-6">
            <div>
                <h1 class="text-3xl sm:text-4xl font-black text-[#ffcc00] flex items-center gap-3 tracking-tight" style="text-shadow: 0 0 20px rgba(255, 204, 0, 0.2);">
                    <i data-lucide="rocket" class="w-8 h-8 sm:w-10 sm:h-10"></i>
                    BIG CRUNCH
                </h1>
                <span class="text-sm font-normal text-gray-500 tracking-normal opacity-70 ml-1">Asistente de Tablero v2.0</span>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                <!-- OBJETIVO DISPLAY -->
                <div class="goal-display px-6 py-3 rounded-xl flex items-center justify-center gap-3 text-white w-full sm:w-auto">
                    <i data-lucide="zap" class="w-6 h-6 text-purple-300 animate-pulse"></i>
                    <div class="flex flex-col">
                        <span class="text-xs text-purple-300 font-bold tracking-widest">OBJETIVO FINAL</span>
                        <span id="goal-mw-display" class="text-2xl font-black font-tech">-- MW</span>
                        <span id="goal-keys-display" class="text-[10px] text-cyan-300 font-bold uppercase border-t border-purple-500/30 pt-1 mt-1">
                            -- LLAVES
                        </span>
                    </div>
                </div>

                <button onclick="resetGame()" class="btn btn-danger py-2 px-5 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2 text-sm whitespace-nowrap h-auto">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    REINICIAR
                </button>
            </div>
        </div>

        <!-- Indicador de Nivel -->
        <div id="level-container" class="card p-6 mb-6 rounded-2xl text-center border-t-4 border-[#1f6feb] relative overflow-hidden">
            <span id="phase-label" class="text-sm font-bold tracking-widest text-blue-400 uppercase mb-2 block">FASE: EXPANSI칍N UNIVERSAL</span>
            <div class="flex justify-center items-center gap-4">
                <span class="text-2xl font-semibold text-gray-400">NIVEL</span>
                <span id="current-level" class="text-7xl font-black text-white" style="text-shadow: 0 0 30px rgba(255,255,255,0.1);">1</span>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
            
            <!-- Left Column: Map & Events -->
            <div class="lg:col-span-7 flex flex-col gap-6">
                
                <!-- Mapa Visual -->
                <div class="card p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2 text-yellow-400">
                            <i data-lucide="map" class="w-6 h-6"></i>
                            Mapa Gal치ctico
                        </h2>
                        <button onclick="handleTurnCycle()" id="btn-next-level" class="btn btn-primary py-2 px-4 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2">
                            <i data-lucide="arrow-right-circle" class="w-4 h-4"></i>
                            SIGUIENTE TURNO
                        </button>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <!-- Grid Container -->
                        <div class="w-full md:w-2/3 bg-[#05070a] p-4 rounded-xl border border-gray-800 shadow-inner">
                            <div id="visual-map" class="map-grid">
                                <!-- Cells injected via JS -->
                            </div>
                        </div>
                        
                        <!-- Info Panel -->
                        <div class="w-full md:w-1/3 flex flex-col gap-4">
                            <div id="map-output" class="text-xs text-gray-400 bg-[#0d1117] p-3 rounded-lg border border-gray-700 h-full">
                                <p class="font-bold text-yellow-500 mb-1">ESTADO</p>
                                Nivel 1 Activo.
                            </div>
                            
                            <!-- Shop Generator Button embedded here for context -->
                            <div class="border-t border-gray-700 pt-4 mt-auto">
                                <h3 class="text-sm font-bold text-blue-400 mb-2 flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i> Tiendas
                                </h3>
                                <button onclick="generateShopLocations()" class="btn btn-secondary w-full py-2 rounded-lg text-xs font-bold text-gray-300 mb-2">
                                    UBICAR TIENDAS
                                </button>
                                <div id="shop-locations-details" class="text-xs text-gray-500 italic h-auto max-h-60 overflow-y-auto custom-scrollbar">
                                    Esperando generaci칩n...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eventos -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-400">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        3. Eventos de Turno
                    </h2>
                    <button onclick="generateEvent()" class="btn btn-danger w-full py-3 rounded-lg font-semibold shadow-md mb-4 bg-opacity-80">
                        GENERAR EVENTOS
                    </button>
                    <div id="event-output" class="bg-[#0d1117] border border-gray-800 p-4 rounded-xl text-sm text-gray-300 flex flex-col gap-2 min-h-[150px]">
                        <div class="text-center italic text-gray-500 my-auto">Pulsa para generar los eventos...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Shop Inventory -->
            <div class="lg:col-span-5">
                <div class="card p-6 rounded-2xl border border-gray-700 h-full flex flex-col">
                    <div class="flex justify-between items-end mb-4 border-b border-gray-700 pb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2 text-green-400">
                            <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                            Mercado
                        </h2>
                        <div class="text-[10px] text-right space-y-1 font-mono text-gray-500" id="shop-rarity-display">
                            <div><span class="inline-block w-2 h-2 rounded-full bg-[#30363d] mr-1"></span>Com칰n 60%</div>
                            <div><span class="inline-block w-2 h-2 rounded-full bg-[#0c2d6b] mr-1"></span>Raro 30%</div>
                            <div><span class="inline-block w-2 h-2 rounded-full bg-[#2e1a4d] mr-1"></span>칄pico 10%</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-3 mb-4">
                        <select id="shop-level-select" onchange="updateShopRarityDisplay(this.value)" class="w-full p-2 rounded-lg bg-[#0d1117] border border-gray-600 text-white text-sm font-bold focus:ring-1 focus:ring-green-500 outline-none">
                            <option value="" disabled selected>Nivel de Tienda</option>
                            <option value="2">Nivel 2</option>
                            <option value="3">Nivel 3</option>
                            <option value="4">Nivel 4</option>
                            <option value="5">Nivel 5 (칄pico)</option>
                        </select>
                        <button onclick="generateShopInventory()" class="btn btn-primary w-full py-2 px-4 rounded-lg font-bold shadow-lg flex justify-center items-center gap-2 bg-gradient-to-r from-green-600 to-teal-600 border-green-500 hover:from-green-500 hover:to-teal-500">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            GENERAR STOCK
                        </button>
                    </div>

                    <div id="shop-inventory-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 overflow-y-auto flex-grow content-start">
                        <div class="col-span-full text-center py-8 text-gray-500 border border-dashed border-gray-700 rounded-xl text-xs">
                            Genera la tienda para ver objetos.
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Secci칩n de Instrucciones -->
        <div class="card p-6 rounded-2xl mt-6 border-t-4 border-cyan-500">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-cyan-400">
                <i data-lucide="book-open" class="w-6 h-6"></i>
                Instrucciones y Conceptos Clave
            </h2>
            
            <div class="space-y-4 text-sm text-gray-300">
                <!-- Orden de Turno -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2">
                        <i data-lucide="list-ordered" class="w-4 h-4"></i>
                        Orden de Turno
                    </h3>
                    <ol class="list-decimal list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Pasar al siguiente nivel:</strong> Usa el bot칩n "SIGUIENTE TURNO" para avanzar de nivel.</li>
                        <li><strong class="text-white">Generar tiendas:</strong> Ubica las tiendas en el mapa usando "UBICAR TIENDAS".</li>
                        <li><strong class="text-white">Turno del jugador:</strong> Realiza tus acciones (movimiento, compras, etc.).</li>
                        <li><strong class="text-white">Eventos:</strong> Al final del turno, clica "GENERAR 3 EVENTOS". <span class="text-red-400 font-semibold">丘멆잺 El da침o de los eventos se aplica inmediatamente al generar los eventos.</span></li>
                    </ol>
                </div>

                <!-- Objetivo y Victoria -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-yellow-500">
                    <h3 class="font-bold text-yellow-400 mb-2 flex items-center gap-2">
                        <i data-lucide="trophy" class="w-4 h-4"></i>
                        Condiciones de Victoria (El Big Crunch)
                    </h3>
                    <p class="text-gray-300 mb-2">Para ganar la partida, todos los jugadores vivos deben llegar al <strong class="text-white">Sistema Central (Nivel 1)</strong> cuando ocurra el Big Crunch final, cumpliendo los siguientes requisitos:</p>
                    <ul class="list-disc list-inside space-y-2 ml-2 text-gray-300">
                        <li>
                            <strong class="text-purple-300">Energ칤a (MW):</strong> Necesaria para estabilizar la nave.
                            <ul class="list-circle list-inside ml-4 mt-1 text-xs text-gray-400">
                                <li>1 Jugador: <strong class="text-white">10 MW</strong></li>
                                <li>2 Jugadores: <strong class="text-white">20 MW</strong></li>
                                <li>3 Jugadores: <strong class="text-white">30 MW</strong></li>
                                <li>4 Jugadores: <strong class="text-white">40 MW</strong></li>
                            </ul>
                        </li>
                        <li>
                            <strong class="text-cyan-300">Llave de la Singularidad:</strong> Necesaria para abrir el n칰cleo.
                            <ul class="list-circle list-inside ml-4 mt-1 text-xs text-gray-400">
                                <li>1-2 Jugadores: <strong class="text-white">1 Llave Completa</strong>.</li>
                                <li>3-4 Jugadores: <strong class="text-white">2 Llaves Completas</strong> .</li>
                            </ul>
                        </li>
                        <li class="border-t border-gray-700 pt-2 mt-2">
                            <strong class="text-yellow-400">춰IMPORTANTE!</strong> Las Llaves de la Singularidad <strong class="text-white">aparecen en los sistemas de Nivel 5</strong> cuando estos se revelan. Deb칠is recogerlas <strong class="text-red-400">ANTES</strong> de que el Nivel 5 colapse, o se perder치n para siempre (Game Over).
                        </li>
                    </ul>
                </div>

                <!-- Da침o de Eventos -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-red-500">
                    <h3 class="font-bold text-red-400 mb-2 flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                        Da침o de Eventos
                    </h3>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Eventos negativos:</strong> Si est치s en el sistema/planeta afectado cuando se generan los eventos, recibes el da침o inmediatamente.</li>
                        <li><strong class="text-white">Excepci칩n - Da침o al pasar:</strong> Los 칰nicos casos donde recibes da침o fuera de la generaci칩n de eventos son:
                            <ul class="list-circle list-inside ml-4 mt-1 space-y-1">
                                <li><strong class="text-yellow-400">Planeta Rebelde:</strong> -1 de da침o a 1 rango (al pasar cerca o por 칠l).</li>
                                <li><strong class="text-yellow-400">Basura Espacial:</strong> -2 de da침o (al pasar por 칠l).</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <!-- Portales -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-green-500">
                    <h3 class="font-bold text-green-400 mb-2 flex items-center gap-2">
                        <i data-lucide="door-open" class="w-4 h-4"></i>
                        Portales
                    </h3>
                    <p class="text-gray-300 ml-2">
                        <strong class="text-white">Pasar por un portal NO cuenta como movimiento del personaje</strong>, pero <strong class="text-orange-400">gastas 1 de combustible</strong> al usarlo. <strong class="text-green-300">Puedes usar el mismo portal tantas veces como quieras en el mismo turno</strong>, gastando <strong class="text-orange-400">1 de combustible por cada uso</strong>.
                    </p>
                </div>

                <!-- Explosi칩n de Sistema -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-orange-500">
                    <h3 class="font-bold text-orange-400 mb-2 flex items-center gap-2">
                        <i data-lucide="flame" class="w-4 h-4"></i>
                        Explosi칩n de Sistema
                    </h3>
                    <p class="text-gray-300 ml-2">
                        Cuando un sistema planetario explota, <strong class="text-white">ya no se puede pasar por ah칤</strong> a menos que tengas la habilidad <strong class="text-cyan-400">Llave Temporal</strong>.
                    </p>
                    <p class="text-gray-300 ml-2 mt-2">
                        <strong class="text-red-400">丘멆잺 MUERTE INMEDIATA:</strong> Si te explota estando dentro del sistema, <strong class="text-red-400">TE MATA DIRECTAMENTE</strong>, quedas muerto.
                    </p>
                </div>

                <!-- Interacci칩n y Compartir -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-purple-500">
                    <h3 class="font-bold text-purple-400 mb-2 flex items-center gap-2">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        Interacci칩n y Movimiento
                    </h3>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Movimiento Libre:</strong> Puedes realizar tantos movimientos como tu personaje permita (4 Explorador, 3 Comerciante). Durante este movimiento, puedes interactuar con <strong class="text-white">TODO</strong> lo que encuentres (Tiendas, Objetos).</li>
                        <li><strong class="text-white">Regla de Tiendas:</strong> Una vez abres una tienda espec칤fica, <strong class="text-red-400">T칔 no puedes volver a usar esa misma tienda este turno</strong> (pero otro jugador s칤). Puedes encadenar varias tiendas diferentes en un mismo turno.</li>
                        <li><strong class="text-white">Compartir (Default):</strong> Si otro jugador est치 en el mismo <strong class="text-white">Planeta</strong>, puedes transferirle Combustible o Cartas (seg칰n acuerdo). <strong class="text-yellow-400">Se te quita de tu nave y se le da a la otra.</strong></li>
                    </ul>
                </div>

                <!-- Recuperaci칩n de Movimientos -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-emerald-500">
                    <h3 class="font-bold text-emerald-400 mb-2 flex items-center gap-2">
                        <i data-lucide="heart-pulse" class="w-4 h-4"></i>
                        Recuperaci칩n de Movimientos
                    </h3>
                    <p class="text-gray-300 ml-2 text-sm">
                        Si durante un turno tienes <strong class="text-yellow-400">velocidad reducida (1/2)</strong> porque tu vida est치 a la mitad o menos, pero <strong class="text-green-400">te curas por encima de la mitad de vida</strong> durante ese mismo turno, <strong class="text-white">recuperas tus movimientos completos</strong>.
                    </p>
                    <p class="text-gray-400 ml-2 text-xs mt-2 italic">
                        Ejemplo: Si tienes 2 movimientos por velocidad reducida, pero al primer movimiento te curas por encima de la mitad, recuperas los <strong class="text-white">3 movimientos</strong> normales (o <strong class="text-white">4</strong> si eres Explorador).
                    </p>
                </div>

                <!-- Jefes Finales (Bosses) -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-yellow-500 mt-4">
                    <h3 class="font-bold text-yellow-400 mb-2 flex items-center gap-2">
                        <i data-lucide="crown" class="w-4 h-4"></i>
                        Jefes Finales (Bosses)
                    </h3>
                    <p class="text-gray-300 ml-2 text-xs mb-2">Al inicio del Big Crunch (antes de caer el Nivel 5), aparecen 2 Bosses en el Nivel 3:</p>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-gray-300 text-xs">
                        <li><strong class="text-yellow-300">Boss Estelar (E)</strong> y <strong class="text-purple-300">Boss Oscuro (O)</strong>.</li>
                        <li><strong class="text-white">C칩mo Vencerlos:</strong> Re칰ne <strong class="text-white">5 puntos de Potencia</strong> del tipo correspondiente (Estelar u Oscura) en la casilla del Boss.</li>
                        <li><strong class="text-white">Cooperativo:</strong> Los puntos pueden sumarse entre jugadores que est칠n en la misma casilla.</li>
                        <li><strong class="text-cyan-400">丘멆잺 IMPORTANTE:</strong> La habilidad <strong class="text-white">Duplicaci칩n Estelar</strong> <strong class="text-red-400">NO FUNCIONA</strong> contra los Bosses. Solo cuentan los puntos de Potencia que <strong class="text-white">realmente tienes</strong>, sin duplicaciones.</li>
                        <li><strong class="text-green-400">Recompensa:</strong> 3 Fichas de Potencia del tipo vencido.</li>
                        <li><strong class="text-red-400">丘멆잺 ADVERTENCIA:</strong> Si vas al planeta del Boss y <strong class="text-white">NO LO COMBATES</strong>, recibes <strong class="text-red-400">-2 de vida</strong>.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Secci칩n de Personajes -->
        <div class="card p-6 rounded-2xl mt-6 border-t-4 border-indigo-500">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-indigo-400">
                <i data-lucide="users" class="w-6 h-6"></i>
                Personajes
            </h2>
            
            <div class="space-y-4 text-sm text-gray-300">
                <!-- Explorador -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-green-500">
                    <h3 class="font-bold text-green-400 mb-2 flex items-center gap-2">
                        <i data-lucide="compass" class="w-4 h-4"></i>
                        Explorador
                    </h3>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Movimiento:</strong> Te puedes mover <strong class="text-green-300">una casilla m치s por defecto</strong> (<strong class="text-white">4 movimientos en total</strong>).</li>
                        <li><strong class="text-white">Combustible:</strong> Tu combustible baja solo <strong class="text-orange-400">1 de combustible por cada 2 movimientos</strong>. Si son impares baja como si fueran 2 (ej: 3 movimientos baja 2 de combustible, 1 movimiento baja 1 combustible).</li>
                        <li><strong class="text-white">Vida a la mitad:</strong> Si baja a mitad de velocidad cuando su vida est치 a la mitad, entonces se mueve m치ximo <strong class="text-yellow-400">2 por defecto</strong> gastando <strong class="text-orange-400">1 de combustible por cada 2 movimientos</strong> igual.</li>
                        <li><strong class="text-white">Recursos iniciales:</strong> <span class="text-orange-400">14 combustible</span> y <span class="text-red-400">10 vidas</span>.</li>
                    </ul>
                </div>

                <!-- Comerciante -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-yellow-500">
                    <h3 class="font-bold text-yellow-400 mb-2 flex items-center gap-2">
                        <i data-lucide="shopping-bag" class="w-4 h-4"></i>
                        Comerciante
                    </h3>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Tiendas:</strong> Este puede coger <strong class="text-green-300">dos objetos de la tienda</strong>, todos los otros solo 1 objeto al visitar una tienda.</li>
                        <li><strong class="text-white">Movimiento:</strong> Este y todos los otros se mueven <strong class="text-white">3 movimientos</strong> gastando <strong class="text-orange-400">combustible por movimiento</strong>.</li>
                        <li><strong class="text-white">Vida a la mitad:</strong> Si le baja vida a la mitad entonces es eso de que se mueve m치ximo <strong class="text-yellow-400">2 movimientos</strong>.</li>
                        <li><strong class="text-white">Recursos iniciales:</strong> <span class="text-orange-400">13 combustible</span> y <span class="text-red-400">10 vidas</span>.</li>
                    </ul>
                </div>

                <!-- Ingeniero -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-cyan-500">
                    <h3 class="font-bold text-cyan-400 mb-2 flex items-center gap-2">
                        <i data-lucide="wrench" class="w-4 h-4"></i>
                        Ingeniero
                    </h3>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Ayuda:</strong> Puede dar vida y combustible al resto de jugadores pero <strong class="text-cyan-300">sin gastar de sus recursos</strong>.</li>
                        <li><strong class="text-white">Mismo planeta:</strong> Si se encuentra en la misma planeta les puede dar m치ximo <span class="text-red-400">5 de vida</span> y <span class="text-orange-400">18 de combustible</span>.</li>
                        <li><strong class="text-white">PASIVA - Curaci칩n:</strong> Por cada movimiento sobrante de los 3 o 2 que pueda tener, se cura gastando <strong class="text-white">1 movimiento</strong>: <span class="text-red-400">+2HP</span> y <span class="text-orange-400">+3 Combustible</span>.</li>
                        <li><strong class="text-white">Recursos iniciales:</strong> <span class="text-orange-400">15 combustible</span> y <span class="text-red-400">9 vidas</span>.</li>
                    </ul>
                </div>

                <!-- Mensajero -->
                <div class="bg-[#0d1117] p-4 rounded-lg border-l-4 border-purple-500">
                    <h3 class="font-bold text-purple-400 mb-2 flex items-center gap-2">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        Mensajero
                    </h3>
                    <ul class="list-disc list-inside space-y-1 ml-2 text-gray-300">
                        <li><strong class="text-white">Transferencia a distancia:</strong> Este personaje puede dar <strong class="text-white">cartas, energ칤a, combustible</strong>, sin necesidad de estar en la misma casilla pero <strong class="text-yellow-400">obviamente se lo resta a 칠l mismo lo que da</strong>.</li>
                        <li><strong class="text-white">Movimiento:</strong> Tiene <strong class="text-white">4 de movimiento</strong> pero el gasta de <strong class="text-orange-400">1 en 1 el combustible</strong>.</li>
                        <li><strong class="text-white">Recursos iniciales:</strong> <span class="text-orange-400">15 combustible</span> y <span class="text-red-400">12 vidas</span>.</li>
                    </ul>
                </div>
            </div>
        </div>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURACI칍N GLOBAL ---
        let nivelActual = 1;
        let faseJuego = 'EXPANSION'; 
        let turnosParaBigCrunch = 2;  
        let activeRoles = []; // Stores selected roles: ['EXPLORADOR', 'COMERCIANTE', etc.]
        let targetMW = 15;
        let requiredKeys = 1;
        
        // ESTADO DEL MAPA (7x7 Grid)
        // Indices 0-48. Center is 24 (Row 3, Col 3).
        // Estructura: mapGrid[index] = { systemName: string, level: number, shops: number }
        let mapGrid = new Array(49).fill(null); 

        // --- SETUP & GAME START LOGIC ---
        
        function updateShopRarityDisplay(val) {
            const level = parseInt(val);
            const container = document.getElementById('shop-rarity-display');
            if (isNaN(level)) return; // Keep default if invalid

            let html = '';
            if (level === 5) {
                // 100% Epico
                html = `
                    <div class="opacity-50 line-through"><span class="inline-block w-2 h-2 rounded-full bg-[#30363d] mr-1"></span>Com칰n 0%</div>
                    <div class="opacity-50 line-through"><span class="inline-block w-2 h-2 rounded-full bg-[#0c2d6b] mr-1"></span>Raro 0%</div>
                    <div class="font-bold text-purple-300"><span class="inline-block w-2 h-2 rounded-full bg-[#2e1a4d] mr-1"></span>칄pico 100%</div>
                `;
            } else if (level === 4) {
                // 50% Com, 30% Rar, 20% Epi
                html = `
                    <div><span class="inline-block w-2 h-2 rounded-full bg-[#30363d] mr-1"></span>Com칰n 50%</div>
                    <div><span class="inline-block w-2 h-2 rounded-full bg-[#0c2d6b] mr-1"></span>Raro 30%</div>
                    <div class="text-purple-300"><span class="inline-block w-2 h-2 rounded-full bg-[#2e1a4d] mr-1"></span>칄pico 20%</div>
                `;
            } else if (level === 2) {
                // 70% Com, 30% Rar, 0% Epi
                html = `
                    <div><span class="inline-block w-2 h-2 rounded-full bg-[#30363d] mr-1"></span>Com칰n 70%</div>
                    <div><span class="inline-block w-2 h-2 rounded-full bg-[#0c2d6b] mr-1"></span>Raro 30%</div>
                    <div class="opacity-50 line-through"><span class="inline-block w-2 h-2 rounded-full bg-[#2e1a4d] mr-1"></span>칄pico 0%</div>
                `;
            } else {
                // Niveles 1 y 3: 60% Com, 30% Rar, 10% Epi
                html = `
                    <div><span class="inline-block w-2 h-2 rounded-full bg-[#30363d] mr-1"></span>Com칰n 60%</div>
                    <div><span class="inline-block w-2 h-2 rounded-full bg-[#0c2d6b] mr-1"></span>Raro 30%</div>
                    <div><span class="inline-block w-2 h-2 rounded-full bg-[#2e1a4d] mr-1"></span>칄pico 10%</div>
                `;
            }
            container.innerHTML = html;
        }

        function toggleRole(role) {
            const btn = document.getElementById(`btn-role-${role.toLowerCase()}`);
            
            if (activeRoles.includes(role)) {
                activeRoles = activeRoles.filter(r => r !== role);
                btn.classList.remove('role-selected');
            } else {
                if (activeRoles.length < 4) {
                    activeRoles.push(role);
                    btn.classList.add('role-selected');
                }
            }
            
            // Update UI
            const startBtn = document.getElementById('btn-start-game');
            const countLabel = document.getElementById('player-count-label');
            const count = activeRoles.length;
            
            if (count > 0) {
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                startBtn.classList.add('shadow-lg', 'hover:scale-105');
                countLabel.innerHTML = `<span class="text-green-400 font-bold">${count}</span> Tripulantes Listos`;
            } else {
                startBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                startBtn.classList.remove('shadow-lg', 'hover:scale-105');
                countLabel.textContent = "Selecciona al menos 1 tripulante";
            }
        }

        function startGame() {
            if (activeRoles.length === 0) return;
            
            // 1. Calculate Goals
            const playerCount = activeRoles.length;
            targetMW = playerCount * 10; // 10, 20, 30, 40 MW
            requiredKeys = (playerCount >= 3) ? 2 : 1;
            
            // 2. Update UI Displays
            document.getElementById('goal-mw-display').textContent = `${targetMW} MW`;
            document.getElementById('goal-keys-display').textContent = `${requiredKeys} LLAVE${requiredKeys > 1 ? 'S' : ''} SINGULARIDAD`;
            
            // 3. Switch Screens
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-app').classList.remove('hidden');
            
            // 4. Init Game
            resetGameInternal(false); // Start without confirming
        }

        // Modified Reset (Internal)
        function resetGameInternal(askConfirm = true) {
             if(askConfirm && !confirm("쯉eguro que quieres reiniciar?")) return;
            
            nivelActual = 1;
            faseJuego = 'EXPANSION';
            turnosParaBigCrunch = 2;
            // Resetear contador de legendarias
            Object.keys(LEGENDARIAS_APARICIONES).forEach(key => delete LEGENDARIAS_APARICIONES[key]);
            initMap(); // Reset map
            updateUIState();
            
            document.getElementById('map-output').innerHTML = "<p class='font-bold text-yellow-500 mb-1'>ESTADO</p>Nivel 1 Iniciado.";
            document.getElementById('shop-locations-details').textContent = "Esperando generaci칩n...";
            document.getElementById('event-output').innerHTML = "<div class='text-center italic text-gray-500 my-auto'>Pulsa para generar los eventos...</div>";
            document.getElementById('shop-inventory-container').innerHTML = '<div class="col-span-full text-center py-8 text-gray-500 border border-dashed border-gray-700 rounded-xl text-xs">Genera la tienda para ver objetos.</div>';
        }

        function resetGame() {
            if(!confirm("Reiniciar misi칩n? Volver치s al men칰 principal.")) return;
            
            // 1. Limpiar visualmente el juego (aunque se oculte)
            nivelActual = 1;
            faseJuego = 'EXPANSION';
            turnosParaBigCrunch = 2;
            initMap();
            
            // 2. Ocultar Juego / Mostrar Men칰
            document.getElementById('game-app').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            
            // 3. Limpiar Estado Interno
            activeRoles = [];
            // Resetear contador de legendarias
            Object.keys(LEGENDARIAS_APARICIONES).forEach(key => delete LEGENDARIAS_APARICIONES[key]);
            
            // 4. Resetear UI de Selecci칩n de Roles
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('role-selected');
            });
            
            // 5. Resetear Bot칩n de Inicio y Texto
            const startBtn = document.getElementById('btn-start-game');
            if(startBtn) {
                startBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                startBtn.classList.remove('shadow-lg', 'hover:scale-105');
            }
            
            const countLabel = document.getElementById('player-count-label');
            if(countLabel) countLabel.textContent = "Selecciona al menos 1 tripulante";
        }
        
        // --- DATA STRUCTURES ---
        
        // Mapeo inverso para busqueda rapida de sistema por planeta
        const PLANET_TO_SYSTEM_MAP = {};

        const SISTEMAS_POR_NIVEL = {
            1: { sistemas: ['Sistema_Tierra'], planetas: ['Planeta_Tierra_Base'] },
            2: {
                sistemas: ['Sistema_Agua', 'Sistema_Tierra_Elemental', 'Sistema_Viento', 'Sistema_Fuego'],
                planetas: ['Planeta_Gota', 'Planeta_Olas', 'Planeta_Roca', 'Planeta_Barro', 'Planeta_Botanico', 'Planeta_Torrnado', 'Planeta_Burbuja', 'Planeta_Chispa', 'Planeta_Magma', 'Planeta_Llamas']
            },
            3: {
                sistemas: ['Sistema_Prehistorico', 'Sistema_Medieval', 'Sistema_FarWest', 'Sistema_Futurista'],
                planetas: ['Planeta_HuevoDino', 'Planeta_Hueso', 'Planeta_Fosil', 'Planeta_Castillo', 'Planeta_Yelmo', 'Planeta_Escudo', 'Planeta_Cadenas', 'Planeta_GorroCowboy', 'Planeta_Dinamita', 'Planeta_Rueda', 'Planeta_Barril', 'Planeta_PlacaBase', 'Planeta_Neon', 'Planeta_Holograma']
            },
            4: {
                sistemas: ['Sistema_Pizza', 'Sistema_Deporte', 'Sistema_Chuche', 'Sistema_Windows'],
                planetas: ['Planeta_Queso', 'Planeta_Tomate', 'Planeta_Cebolla', 'Planeta_Pepperoni', 'Planeta_Champi침on', 'Planeta_Futbol', 'Planeta_Basket', 'Planeta_Voley', 'Planeta_Tenis', 'Planeta_Beisbol', 'Planeta_Piruleta', 'Planeta_Chicle', 'Planeta_Gominola', 'Planeta_Nube', 'Planeta_Archivos', 'Planeta_MiPC', 'Planeta_Papelera', 'Planeta_InternetExplorer']
            },
            5: {
                sistemas: ['Sistema_Geometria_Minimalista', 'Sistema_Gemas'],
                planetas: ['Planeta_Poligono_3', 'Planeta_Poligono_4', 'Planeta_Poligono_5', 'Planeta_Poligono_6', 'Planeta_Poligono_7', 'Planeta_Rubi', 'Planeta_Topacio', 'Planeta_Lapislazuli', 'Planeta_Esmalte', 'Planeta_Diamante']
            }
        };

        // Inicializar Mapa Inverso
        for(let lvl in SISTEMAS_POR_NIVEL) {
            const sysList = SISTEMAS_POR_NIVEL[lvl].sistemas;
            const planetList = SISTEMAS_POR_NIVEL[lvl].planetas;
            // Asumimos que la asignacion de planetas a sistemas es implicita en el orden o bloques? 
            // El PDF agrupa planetas bajo sistemas. Para simplificar la logica de "En que sistema esta el planeta",
            // vamos a asignar todos los planetas del nivel a sus sistemas.
            // Pero espera, el PDF lista "Sistema X -> Planeta A, Planeta B".
            // Necesito esa asociacion exacta para el mapa.
            // Voy a reconstruir un mapping manual rapido basado en el PDF para exactitud.
        }
        
        // Mapping exacto manual (PDF 1.2)
        const SYSTEM_PLANET_RELATION = {
            'Sistema_Tierra': ['Planeta_Tierra_Base'],
            'Sistema_Agua': ['Planeta_Gota', 'Planeta_Olas'],
            'Sistema_Tierra_Elemental': ['Planeta_Roca', 'Planeta_Barro', 'Planeta_Botanico'],
            'Sistema_Viento': ['Planeta_Torrnado', 'Planeta_Burbuja'],
            'Sistema_Fuego': ['Planeta_Chispa', 'Planeta_Magma', 'Planeta_Llamas'],
            'Sistema_Prehistorico': ['Planeta_HuevoDino', 'Planeta_Hueso', 'Planeta_Fosil'],
            'Sistema_Medieval': ['Planeta_Castillo', 'Planeta_Yelmo', 'Planeta_Escudo', 'Planeta_Cadenas'],
            'Sistema_FarWest': ['Planeta_GorroCowboy', 'Planeta_Dinamita', 'Planeta_Rueda', 'Planeta_Barril'],
            'Sistema_Futurista': ['Planeta_PlacaBase', 'Planeta_Neon', 'Planeta_Holograma'],
            'Sistema_Pizza': ['Planeta_Queso', 'Planeta_Tomate', 'Planeta_Cebolla', 'Planeta_Pepperoni', 'Planeta_Champi침on'],
            'Sistema_Deporte': ['Planeta_Futbol', 'Planeta_Basket', 'Planeta_Voley', 'Planeta_Tenis', 'Planeta_Beisbol'],
            'Sistema_Chuche': ['Planeta_Piruleta', 'Planeta_Chicle', 'Planeta_Gominola', 'Planeta_Nube'],
            'Sistema_Windows': ['Planeta_Archivos', 'Planeta_MiPC', 'Planeta_Papelera', 'Planeta_InternetExplorer'],
            'Sistema_Geometria_Minimalista': ['Planeta_Poligono_3', 'Planeta_Poligono_4', 'Planeta_Poligono_5', 'Planeta_Poligono_6', 'Planeta_Poligono_7'],
            'Sistema_Gemas': ['Planeta_Rubi', 'Planeta_Topacio', 'Planeta_Lapislazuli', 'Planeta_Esmalte', 'Planeta_Diamante']
        };

        // Llenar PLANET_TO_SYSTEM_MAP
        for (const [sys, planets] of Object.entries(SYSTEM_PLANET_RELATION)) {
            planets.forEach(p => PLANET_TO_SYSTEM_MAP[p] = sys);
        }

        const EVENTOS_NEGATIVOS_SISTEMA = ['Evento_Explosion_Sistema', 'Evento_Sistema_Infectado'];
        const EVENTOS_NEGATIVOS_PLANETA = ['Evento_Basura Espacial', 'Planeta_Rebelde']; // Personales separado
        const EVENTO_OBJETOS_POOL = [
            { id: 'Combustible_Lata_Peque침a', tipoObjeto: 'Combustible', rareza: 'comun', desc: '+3 Combustible' },
            { id: 'Medkit_Peque침o', tipoObjeto: 'Vida', rareza: 'comun', desc: '+2 HP' },
            { id: 'Estelar_BrilloEstelar', tipoObjeto: 'Potencia', rareza: 'comun', potenciaValor: 1 },
            { id: 'Oscura_Pozo', tipoObjeto: 'Potencia', rareza: 'comun', potenciaValor: 1 }
        ];
        const POTENCIA_3_POOL = [
             { id: 'Estelar_NucleoEstelar', tipoObjeto: 'Potencia', rareza: 'epico', potenciaValor: 3 },
             { id: 'Oscura_ColapsoGravitacional', tipoObjeto: 'Potencia', rareza: 'epico', potenciaValor: 3 }
        ];
        const EVENTOS_PERSONALES_POOL = [
            { id: 'ChoqueEspacial', desc: 'Jugador {ROLE}  Vida -2.' },
            { id: 'SobrecalentamientoMotor', desc: 'Jugador {ROLE}  Combustible -2.' },
            { id: 'Interferencias', desc: 'Jugador {ROLE} no puede hablar hasta SIGUIENTE TURNO.', rareza: 'epico' } // 10%
        ];

        const ITEMS_POR_TIPO = {
            Combustible: [
                { id: 'Combustible_Lata_Peque침a', rareza: 'comun', niveles: [2, 3, 4, 5], desc: '+3 Combustible' },
                { id: 'Combustible_Lata_Media', rareza: 'raro', niveles: [3, 4, 5], desc: '+6 Combustible' },
                { id: 'Combustible_Tanque_Grande', rareza: 'epico', niveles: [4, 5], desc: '+10 Combustible' },
            ],
            Vida: [
                { id: 'Medkit_Peque침o', rareza: 'comun', niveles: [2, 3, 4, 5], desc: '+2 HP' },
                { id: 'Medkit_Medio', rareza: 'raro', niveles: [3, 4, 5], desc: '+4 HP' },
                { id: 'Medkit_Grande', rareza: 'epico', niveles: [4, 5], desc: '+6 HP' },
            ],
            Potencia: [
                { id: 'Estelar_BrilloEstelar', rareza: 'comun', niveles: [2, 3, 4, 5], potenciaValor: 1 },
                { id: 'Estelar_PulsoEstelar', rareza: 'raro', niveles: [3, 4, 5], potenciaValor: 2 },
                { id: 'Estelar_NucleoEstelar', rareza: 'epico', niveles: [4, 5], potenciaValor: 3 },
                { id: 'Oscura_Pozo', rareza: 'comun', niveles: [2, 3, 4, 5], potenciaValor: 1 },
                { id: 'Oscura_OrbitaDensa', rareza: 'raro', niveles: [3, 4, 5], potenciaValor: 2 },
                { id: 'Oscura_ColapsoGravitacional', rareza: 'epico', niveles: [4, 5], potenciaValor: 3 },
            ],
            Especial: [
                { id: 'Carta_UltimaVoluntad_CorreoPrime', rareza: 'epico', niveles: [2, 3, 4, 5], desc: 'AL MORIR: Env칤a fichas Potencia y hasta 2 cartas a un jugador vivo.' },
            ],
            Habilidad: [
                { id: 'Habilidad_Estelar_Chispa', rareza: 'raro', niveles: [2, 3], desc: 'ACTIVA: Mueve +1 planeta gratis al comprar Estelar.' },
                { id: 'Habilidad_Grav_SaltoGravitacional', rareza: 'raro', niveles: [2, 3], desc: 'ACTIVA: Al comprar poder oscuro, en el siguiente turno, +2 movimiento gratis (sin combustible) siempre y cuando dentro de estos 2 movimientos te permitan llegar a una tienda.' },
                { id: 'Habilidad_Grav_AtraerObjeto', rareza: 'raro', niveles: [3, 4], desc: 'ACTIVA: Atrae objeto (dist 3).' },
                { id: 'Habilidad_Expansi칩nTemporal', rareza: 'raro', niveles: [3, 4], desc: 'ACTIVA: Repite movimiento.' },
                { id: 'Habilidad_Estelar_Duplicacion', rareza: 'epico', niveles: [5], desc: 'PASIVA: Estelares x2.', legendaria: true, maxApariciones: 1 },
                { id: 'Habilidad_Grav_MasaDoble', rareza: 'epico', niveles: [5], desc: 'PASIVA: Gravitatorias x2.', legendaria: true, maxApariciones: 1 },
                { id: 'Habilidad_Protecci칩nPlanetaria', rareza: 'epico', niveles: [4, 5], desc: 'PASIVA: Protege hasta 1 de da침o por turno.' },
                { id: 'Habilidad_LlaveTemporal', rareza: 'epico', niveles: [3, 4], desc: 'PASIVA: Permite pasar por sistemas planetarios explotados.' },
                { id: 'Habilidad_LlaveTemporal', rareza: 'raro', niveles: [4, 5], desc: 'PASIVA: Permite pasar por sistemas planetarios explotados.' },
                { id: 'Habilidad_EstabilizadorEstelar', rareza: 'epico', niveles: [3,5], desc: 'ACTIVA: Evita la explosi칩n inminente de un sistema planetario (un solo uso, donde sea del universo).' },
                { id: 'Habilidad_EstabilizadorEstelar', rareza: 'raro', niveles: [4], desc: 'ACTIVA: Evita la explosi칩n inminente de un sistema planetario (un solo uso, donde sea del universo).' },
                { id: 'Habilidad_CrearPortal', rareza: 'epico', niveles: [5], desc: 'ACTIVA: Crea un portal de 2 puertas (2 planetas) donde t칰 quieras del universo.', legendaria: true, maxApariciones: 1 },
                { id: 'Habilidad_DisfrazRebelde', rareza: 'raro', niveles: [3, 4, 5], desc: 'PASIVA: No te afectan los planetas rebeldes.' },
                { id: 'Habilidad_MembranaAntiradioactiva', rareza: 'raro', niveles: [3, 4, 5], desc: 'PASIVA: No te afectan los sistemas planetarios infectados.' },
                { id: 'Habilidad_LimpiezaEspacial', rareza: 'raro', niveles: [3, 4, 5], desc: 'ACTIVA: Limpias la basura espacial de un sistema planetario.' },
                { id: 'Habilidad_CompartirEsVivir', rareza: 'raro', niveles: [3, 4, 5], desc: 'ACTIVA: Puedes transferir 2 Vida y/o 3 Combustible tuyos a un aliado.' },
            ],
        };

        const RAREZA_PROBABILIDAD = { 'comun': 0.60, 'raro': 0.30, 'epico': 0.10 };

        // --- CONTADOR DE LEGENDARIAS ---
        // Rastrea cu치ntas veces ha aparecido cada carta legendaria
        const LEGENDARIAS_APARICIONES = {};

        // --- UTILS ---
        function getRandomElement(arr) {
            if (!arr || arr.length === 0) return null;
            return arr[Math.floor(Math.random() * arr.length)];
        }
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        function generateRareza(forcedRarity = null, nivel = null) {
            if (forcedRarity) return forcedRarity;
            
            // Probabilidades seg칰n nivel
            let probComun, probRaro, probEpico;
            if (nivel === 5) {
                // Nivel 5: 100% 칠pico
                probComun = 0;
                probRaro = 0;
                probEpico = 1.0;
            } else if (nivel === 4) {
                // Nivel 4: 50% com칰n, 30% raro, 20% 칠pico
                probComun = 0.50;
                probRaro = 0.30;
                probEpico = 0.20;
            } else if (nivel === 2) {
                // Nivel 2: 70% com칰n, 30% raro, 0% 칠pico
                probComun = 0.70;
                probRaro = 0.30;
                probEpico = 0.0;
            } else {
                // Niveles 1 y 3: 60% com칰n, 30% raro, 10% 칠pico
                probComun = RAREZA_PROBABILIDAD.comun;
                probRaro = RAREZA_PROBABILIDAD.raro;
                probEpico = RAREZA_PROBABILIDAD.epico;
            }
            
            const rand = Math.random();
            if (rand < probComun) return 'comun';
            if (rand < probComun + probRaro) return 'raro';
            return 'epico';
        }

        // --- MAP LOGIC (7x7) ---
        // Indices calculados (Row * 7 + Col)
        // Centro (3,3) = 24
        const MAP_SLOTS = {
            1: [24], // Center
            2: [17, 25, 31, 23], // N(3,2)=17+? No: 2*7+3=17. E(3,4)=25. S(4,3)=31. W(3,2)? No row=3, col=2 -> 23. Correct. (N, E, S, W)
            3: [16, 18, 32, 30], // NW(2,2)=16. NE(2,4)=18. SE(4,4)=32. SW(4,2)=30. (NW, NE, SE, SW)
            4: [10, 39, 27, 21], // N2(1,3)=10. S2(5,3)=38? 5*7+3=38. Wait, my math. Row 5, col 3.
                // Let's verify.
                // Center 24 = (3,3).
                // N (-1 y) = (2,3) = 17.
                // S (+1 y) = (4,3) = 31.
                // E (+1 x) = (3,4) = 25.
                // W (-1 x) = (3,2) = 23.
                // NW (-1,-1) = (2,2) = 16.
                // NE (-1, 1) = (2,4) = 18.
                // SW (1, -1) = (4,2) = 30.
                // SE (1, 1) = (4,4) = 32.
                // L4 (Dist 2 Cardinal):
                // N2 (1,3) = 1*7+3 = 10.
                // S2 (5,3) = 5*7+3 = 38.
                // E2 (3,5) = 3*7+5 = 26.
                // W2 (3,1) = 3*7+1 = 22.
            5: [3, 45, 27, 21] // Dist 3 Cardinal.
                // N3 (0,3) = 3.
                // S3 (6,3) = 45.
                // E3 (3,6) = 27.
                // W3 (3,0) = 21.
        };
        // Fix L4 indices in constant
        const MAP_SLOTS_FIXED = {
            1: [24],
            2: [17, 25, 31, 23], // N, E, S, W
            3: [16, 18, 32, 30], // NW, NE, SE, SW
            4: [10, 26, 38, 22], // N, E, S, W
            5: [3, 27, 45, 21]   // N, E, S, W
        };

        function initMap() {
            mapGrid = new Array(49).fill(null);
            // Nivel 1 siempre fijo
            const sysName = 'Sistema_Tierra';
            const planetStates = { 'Planeta_Tierra_Base': { shops: 0, eventObjects: 0, eventPortals: 0, eventNegative: 0, rebel: 0, garbage: 0 } };
            mapGrid[24] = { systemName: sysName, level: 1, planetStates: planetStates, systemDanger: false, systemInfected: false };
            renderMap();
        }

        function updateMapForLevel(level) {
            if (level > 5) return;
            if (!MAP_SLOTS_FIXED[level]) return;

            const sistemas = shuffleArray(SISTEMAS_POR_NIVEL[level].sistemas);
            const slots = MAP_SLOTS_FIXED[level];

            // Nivel 5 solo usa 2 slots aleatorios de los 4 disponibles
            if (level === 5) {
                const pickedSlots = shuffleArray(slots).slice(0, 2);
                
                // LOGIC FOR KEYS (LLAVES SINGULARIDAD)
                // If 1-2 players -> 1 Key total. If 3-4 players -> 2 Keys total.
                const totalKeys = (activeRoles.length >= 3) ? 2 : 1;
                
                for(let i=0; i<2; i++) {
                    // Initialize planet states for specific tracking
                    const sysName = sistemas[i];
                    const planetas = SYSTEM_PLANET_RELATION[sysName] || [];
                    const planetStates = {};
                    
                    // Decide if this system gets a Key
                    let hasKey = false;
                    if (totalKeys === 2) hasKey = true; // Both systems get a key
                    else if (totalKeys === 1 && i === 0) hasKey = true; // Only first system gets key
                    
                    planetas.forEach((p, idx) => {
                        planetStates[p] = { shops: 0, eventObjects: 0, eventPortals: 0, eventNegative: 0, hasKey: false };
                    });
                    
                    if (hasKey) {
                        const randomPlanet = planetas[Math.floor(Math.random() * planetas.length)];
                        planetStates[randomPlanet].hasKey = true;
                    }
                    
                    mapGrid[pickedSlots[i]] = { 
                        systemName: sysName, 
                        level: 5, 
                        systemDanger: false,
                        systemInfected: false,
                        planetStates: planetStates 
                    };
                }
                
                // NOTIFICATION FOR KEYS
                const mapOutput = document.getElementById('map-output');
                mapOutput.innerHTML += `<br><span class="text-yellow-400 font-bold animate-pulse">춰DETECTADA LLAVE SINGULARIDAD!</span><br><span class="text-[10px]">Rec칩gela antes del colapso.</span>`;

            } else {
                // Niveles 2, 3, 4 llenan todos sus slots
                for(let i=0; i<slots.length; i++) {
                    if (sistemas[i]) {
                        const sysName = sistemas[i];
                        const planetas = SYSTEM_PLANET_RELATION[sysName] || [];
                        const planetStates = {};
                        planetas.forEach(p => {
                            planetStates[p] = { shops: 0, eventObjects: 0, eventPortals: 0, eventNegative: 0, rebel: 0, garbage: 0 };
                        });

                        mapGrid[slots[i]] = { 
                            systemName: sysName, 
                            level: level, 
                            systemDanger: false,
                            systemInfected: false,
                            planetStates: planetStates
                        };
                    }
                }
            }
            renderMap();
        }

        // --- CONFIGURACI칍N VISUAL DE SISTEMAS ---
        const SYSTEM_LAYOUTS_CONFIG = {
            // NIVEL 1
            'Sistema_Tierra': {
                nodes: [ { id: 'Planeta_Tierra_Base', x: 50, y: 50 } ],
                connections: [],
                exits: { N: 'Planeta_Tierra_Base', E: 'Planeta_Tierra_Base', S: 'Planeta_Tierra_Base', W: 'Planeta_Tierra_Base' }
            },

            // NIVEL 2
            'Sistema_Fuego': {
                nodes: [
                    { id: 'Planeta_Llamas', x: 50, y: 20 }, // Arriba
                    { id: 'Planeta_Chispa', x: 80, y: 60 }, // Der
                    { id: 'Planeta_Magma', x: 20, y: 60 }   // Izq
                ],
                connections: [['Planeta_Llamas','Planeta_Chispa'], ['Planeta_Chispa','Planeta_Magma'], ['Planeta_Magma','Planeta_Llamas']],
                exits: { N: 'Planeta_Llamas', E: 'Planeta_Chispa', S: 'Planeta_Chispa', W: 'Planeta_Magma' }
            },
            'Sistema_Viento': {
                nodes: [
                    { id: 'Planeta_Burbuja', x: 30, y: 40 }, // Izq Arriba
                    { id: 'Planeta_Torrnado', x: 70, y: 60 } // Der Abajo
                ],
                connections: [['Planeta_Burbuja', 'Planeta_Torrnado']],
                exits: { N: 'Planeta_Burbuja', E: 'Planeta_Torrnado', S: 'Planeta_Torrnado', W: 'Planeta_Burbuja' }
            },
            'Sistema_Tierra_Elemental': { // "sistema tierra" en imagen
                nodes: [
                    { id: 'Planeta_Roca', x: 70, y: 30 },    // Arriba Der
                    { id: 'Planeta_Botanico', x: 20, y: 40 },// Izq
                    { id: 'Planeta_Barro', x: 50, y: 80 }    // Abajo
                ],
                connections: [['Planeta_Roca','Planeta_Barro'], ['Planeta_Barro','Planeta_Botanico'], ['Planeta_Botanico','Planeta_Roca']],
                exits: { N: 'Planeta_Roca', E: 'Planeta_Roca', S: 'Planeta_Barro', W: 'Planeta_Botanico' }
            },
            'Sistema_Agua': {
                nodes: [
                    { id: 'Planeta_Olas', x: 40, y: 30 }, // Arriba Izq
                    { id: 'Planeta_Gota', x: 60, y: 70 }  // Abajo Der
                ],
                connections: [['Planeta_Olas', 'Planeta_Gota']],
                exits: { N: 'Planeta_Olas', E: 'Planeta_Olas', S: 'Planeta_Gota', W: 'Planeta_Olas' }
            },

            // NIVEL 3
            'Sistema_Prehistorico': {
                nodes: [
                    { id: 'Planeta_Hueso', x: 20, y: 25 },    // Arriba Izq
                    { id: 'Planeta_Fosil', x: 80, y: 25 },    // Arriba Der
                    { id: 'Planeta_HuevoDino', x: 50, y: 70 } // Abajo
                ],
                connections: [['Planeta_Hueso','Planeta_Fosil'], ['Planeta_Fosil','Planeta_HuevoDino'], ['Planeta_HuevoDino','Planeta_Hueso']],
                exits: { N: 'Planeta_Hueso', E: 'Planeta_Fosil', S: 'Planeta_HuevoDino', W: 'Planeta_Hueso' }
            },
            'Sistema_FarWest': {
                nodes: [
                    { id: 'Planeta_Dinamita', x: 50, y: 20 },    // Arriba
                    { id: 'Planeta_GorroCowboy', x: 80, y: 50 }, // Der
                    { id: 'Planeta_Barril', x: 70, y: 80 }, // Abajo Der
                    { id: 'Planeta_Rueda', x: 20, y: 60 }        // Izq
                ],
                connections: [['Planeta_Dinamita','Planeta_GorroCowboy'], ['Planeta_GorroCowboy','Planeta_Barril'], ['Planeta_Barril','Planeta_Rueda'], ['Planeta_Rueda','Planeta_Dinamita']],
                exits: { N: 'Planeta_Dinamita', E: 'Planeta_GorroCowboy', S: 'Planeta_Barril', W: 'Planeta_Rueda' }
            },
            'Sistema_Medieval': {
                nodes: [
                    { id: 'Planeta_Yelmo', x: 70, y: 30 },   // Arriba Der
                    { id: 'Planeta_Castillo', x: 50, y: 70 }, // Abajo
                    { id: 'Planeta_Cadenas', x: 20, y: 80 },  // Abajo Izq
                    { id: 'Planeta_Escudo', x: 20, y: 40 }    // Arriba Izq
                ],
                connections: [['Planeta_Yelmo','Planeta_Castillo'], ['Planeta_Castillo','Planeta_Cadenas'], ['Planeta_Cadenas','Planeta_Escudo'], ['Planeta_Escudo','Planeta_Yelmo']],
                exits: { N: 'Planeta_Yelmo', E: 'Planeta_Yelmo', S: 'Planeta_Castillo', W: 'Planeta_Cadenas' }
            },
            'Sistema_Futurista': {
                nodes: [
                    { id: 'Planeta_Neon', x: 40, y: 20 },     // Arriba
                    { id: 'Planeta_PlacaBase', x: 80, y: 40 }, // Der
                    { id: 'Planeta_Holograma', x: 50, y: 85 }  // Abajo
                ],
                connections: [['Planeta_Neon','Planeta_PlacaBase'], ['Planeta_PlacaBase','Planeta_Holograma'], ['Planeta_Holograma','Planeta_Neon']],
                exits: { N: 'Planeta_Neon', E: 'Planeta_PlacaBase', S: 'Planeta_Holograma', W: 'Planeta_Neon' }
            },

            // NIVEL 4
            'Sistema_Windows': {
                nodes: [
                    { id: 'Planeta_InternetExplorer', x: 50, y: 15 }, // Arriba "explorer"
                    { id: 'Planeta_Archivos', x: 80, y: 50 },         // Der "archivos"
                    { id: 'Planeta_MiPC', x: 50, y: 85 },             // Abajo "mi pc"
                    { id: 'Planeta_Papelera', x: 20, y: 50 }          // Izq "papelera"
                ],
                connections: [['Planeta_InternetExplorer','Planeta_Archivos'], ['Planeta_Archivos','Planeta_MiPC'], ['Planeta_MiPC','Planeta_Papelera'], ['Planeta_Papelera','Planeta_InternetExplorer']],
                exits: { N: 'Planeta_InternetExplorer', E: 'Planeta_Archivos', S: 'Planeta_MiPC', W: 'Planeta_Papelera' }
            },
            'Sistema_Deporte': {
                nodes: [
                    { id: 'Planeta_Tenis', x: 40, y: 15 },   // Arriba
                    { id: 'Planeta_Voley', x: 85, y: 20 },   // Arriba Der
                    { id: 'Planeta_Futbol', x: 85, y: 60 },  // Abajo Der
                    { id: 'Planeta_Beisbol', x: 50, y: 85 }, // Abajo
                    { id: 'Planeta_Basket', x: 15, y: 50 }   // Izq
                ],
                connections: [['Planeta_Tenis','Planeta_Voley'], ['Planeta_Voley','Planeta_Futbol'], ['Planeta_Futbol','Planeta_Beisbol'], ['Planeta_Beisbol','Planeta_Basket'], ['Planeta_Basket','Planeta_Tenis']],
                exits: { N: 'Planeta_Tenis', E: 'Planeta_Futbol', S: 'Planeta_Beisbol', W: 'Planeta_Basket' }
            },
            'Sistema_Pizza': {
                nodes: [
                    { id: 'Planeta_Cebolla', x: 20, y: 30 },   // Arriba Izq
                    { id: 'Planeta_Tomate', x: 70, y: 30 },    // Arriba Der
                    { id: 'Planeta_Champi침on', x: 50, y: 90 }, // Abajo
                    { id: 'Planeta_Pepperoni', x: 20, y: 80 }, // Abajo Izq
                    { id: 'Planeta_Queso', x: 50, y: 60 }      // Centro
                ],
                connections: [['Planeta_Cebolla','Planeta_Tomate'], ['Planeta_Tomate','Planeta_Queso'], ['Planeta_Queso','Planeta_Pepperoni'], ['Planeta_Pepperoni','Planeta_Cebolla'], ['Planeta_Queso', 'Planeta_Champi침on']],
                exits: { N: 'Planeta_Cebolla', E: 'Planeta_Tomate', S: 'Planeta_Champi침on', W: 'Planeta_Pepperoni' }
            },
            'Sistema_Chuche': {
                nodes: [
                    { id: 'Planeta_Gominola', x: 50, y: 20 }, // Arriba
                    { id: 'Planeta_Chicle', x: 85, y: 45 },   // Der
                    { id: 'Planeta_Piruleta', x: 80, y: 80 }, // Abajo Der
                    { id: 'Planeta_Nube', x: 20, y: 75 }      // Abajo Izq
                ],
                connections: [['Planeta_Gominola','Planeta_Chicle'], ['Planeta_Chicle','Planeta_Piruleta'], ['Planeta_Piruleta','Planeta_Nube'], ['Planeta_Nube','Planeta_Gominola']],
                exits: { N: 'Planeta_Gominola', E: 'Planeta_Chicle', S: 'Planeta_Piruleta', W: 'Planeta_Nube' }
            },

            // NIVEL 5
            'Sistema_Gemas': {
                nodes: [
                    { id: 'Planeta_Esmalte', x: 25, y: 20 },      // Arriba Izq
                    { id: 'Planeta_Lapislazuli', x: 75, y: 20 },  // Arriba Der
                    { id: 'Planeta_Topacio', x: 90, y: 50 },      // Der
                    { id: 'Planeta_Rubi', x: 50, y: 80 },         // Abajo
                    { id: 'Planeta_Diamante', x: 10, y: 50 }      // Izq
                ],
                connections: [['Planeta_Esmalte','Planeta_Lapislazuli'], ['Planeta_Lapislazuli','Planeta_Topacio'], ['Planeta_Topacio','Planeta_Rubi'], ['Planeta_Rubi','Planeta_Diamante'], ['Planeta_Diamante','Planeta_Esmalte']],
                exits: { N: 'Planeta_Lapislazuli', E: 'Planeta_Topacio', S: 'Planeta_Rubi', W: 'Planeta_Diamante' }
            },
            'Sistema_Geometria_Minimalista': {
                nodes: [
                    { id: 'Planeta_Poligono_6', x: 30, y: 20 }, // Arriba Izq (Hex)
                    { id: 'Planeta_Poligono_4', x: 70, y: 40 }, // Arriba Der (Cuadrado)
                    { id: 'Planeta_Poligono_3', x: 50, y: 80 }, // Abajo (Triangulo)
                    { id: 'Planeta_Poligono_5', x: 20, y: 70 }, // Abajo Izq (Pentagono)
                    { id: 'Planeta_Poligono_7', x: 85, y: 75 }  // Abajo Der (Octogono en imagen, es 7 o 8?)
                ],
                connections: [['Planeta_Poligono_6','Planeta_Poligono_4'], ['Planeta_Poligono_4','Planeta_Poligono_7'], ['Planeta_Poligono_7','Planeta_Poligono_3'], ['Planeta_Poligono_3','Planeta_Poligono_5'], ['Planeta_Poligono_5','Planeta_Poligono_6']],
                exits: { N: 'Planeta_Poligono_6', E: 'Planeta_Poligono_4', S: 'Planeta_Poligono_3', W: 'Planeta_Poligono_5' }
            }
        };

        function getSystemLayout(systemName) {
            // Si tenemos config manual, usarla
            if (SYSTEM_LAYOUTS_CONFIG[systemName]) {
                return SYSTEM_LAYOUTS_CONFIG[systemName];
            }
            
            // Fallback autom치tico si falta alguno
            const planets = SYSTEM_PLANET_RELATION[systemName] || ['Unknown'];
            const count = planets.length;
            let nodes = [];
            
            // ... (L칩gica de fallback simple anterior) ...
            const radius = 35;
            const centerX = 50;
            const centerY = 50;
            for(let i=0; i<count; i++) {
                const angle = (i / count) * 2 * Math.PI - (Math.PI/2);
                nodes.push({
                    id: planets[i],
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                });
            }
            
            return {
                nodes: nodes,
                connections: [], // No auto-connections
                exits: { N: nodes[0]?.id, E: nodes[1]?.id, S: nodes[nodes.length-1]?.id, W: nodes[nodes.length-1]?.id }
            };
        }

        function renderMap() {
            const gridEl = document.getElementById('visual-map');
            gridEl.innerHTML = '';

            // Calcular el tama침o del grid din치micamente bas치ndose en celdas ocupadas
            let occupiedCells = [];
            for(let i=0; i<49; i++) {
                if (mapGrid[i]) {
                    const row = Math.floor(i / 7);
                    const col = i % 7;
                    occupiedCells.push({index: i, row, col});
                }
            }

            // Calcular l칤mites (min/max row y col)
            let minRow = 3, maxRow = 3, minCol = 3, maxCol = 3; // Empieza en centro (3,3)
            if (occupiedCells.length > 0) {
                minRow = Math.min(...occupiedCells.map(c => c.row));
                maxRow = Math.max(...occupiedCells.map(c => c.row));
                minCol = Math.min(...occupiedCells.map(c => c.col));
                maxCol = Math.max(...occupiedCells.map(c => c.col));
            }

            const gridRows = maxRow - minRow + 1;
            const gridCols = maxCol - minCol + 1;
            const gridSize = Math.max(gridRows, gridCols); // Cuadrado

            // Ajustar el grid CSS din치micamente
            gridEl.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;

            // Escalar elementos seg칰n el tama침o del grid (m치s peque침o = m치s espacio por celda)
            // 1x1 = 2.5x, 3x3 = 1.8x, 5x5 = 1.3x, 7x7 = 1x
            const scaleFactor = gridSize === 1 ? 2.5 : gridSize === 3 ? 1.8 : gridSize === 5 ? 1.3 : 1.0;
            
            // Aplicar escala din치mica al contenedor
            gridEl.style.setProperty('--scale-factor', scaleFactor);

            // Renderizar solo las celdas necesarias
            for(let r = minRow; r <= minRow + gridSize - 1; r++) {
                for(let c = minCol; c <= minCol + gridSize - 1; c++) {
                    const i = r * 7 + c;
                    
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    
                    const data = mapGrid[i];
                    if (data) {
                        cell.classList.add(`cell-lvl-${data.level}`);
                        
                        const layout = getSystemLayout(data.systemName);
                        const nodes = layout.nodes;
                        const connections = layout.connections;
                        const exits = layout.exits;
                        
                        // SVG Connections
                        let svgHTML = `<svg class="connections-svg" viewBox="0 0 100 100">`;
                        
                        // 1. External Connections (Salidas)
                        if (exits) {
                            const nNode = nodes.find(n => n.id === exits.N);
                            if(nNode) svgHTML += `<line x1="${nNode.x}" y1="${nNode.y}" x2="50" y2="0" class="connection-line" />`;
                            
                            const eNode = nodes.find(n => n.id === exits.E);
                            if(eNode) svgHTML += `<line x1="${eNode.x}" y1="${eNode.y}" x2="100" y2="50" class="connection-line" />`;
                            
                            const sNode = nodes.find(n => n.id === exits.S);
                            if(sNode) svgHTML += `<line x1="${sNode.x}" y1="${sNode.y}" x2="50" y2="100" class="connection-line" />`;
                            
                            const wNode = nodes.find(n => n.id === exits.W);
                            if(wNode) svgHTML += `<line x1="${wNode.x}" y1="${wNode.y}" x2="0" y2="50" class="connection-line" />`;
                        }
                        
                        // 2. Internal Connections (l칤nea m치s gruesa en grids peque침os)
                        const lineWidth = scaleFactor * 1.5;
                        connections.forEach(pair => {
                             const p1 = nodes.find(n => n.id === pair[0]);
                             const p2 = nodes.find(n => n.id === pair[1]);
                             if (p1 && p2) {
                                 svgHTML += `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" class="connection-line" style="stroke-width: ${lineWidth}px;" />`;
                             }
                        });
                        
                        svgHTML += `</svg>`;
                        
                        // Planets Nodes (escalados)
                        let nodesHTML = '';
                        const nodeSize = 12 * scaleFactor;
                        nodes.forEach(p => {
                            const pState = data.planetStates && data.planetStates[p.id] ? data.planetStates[p.id] : { shops:0, eventObjects:0, eventPortals:0, eventNegative:0, rebel:0, garbage:0, boss:null, hasKey:false };
                            
                            let badges = '';
                            const badgeSize = 14 * scaleFactor;
                            const badgeFontSize = 8 * scaleFactor;
                            
                            if(pState.boss === 'ESTELAR') badges += `<div class="planet-badge badge-boss badge-boss-stellar" style="width:${badgeSize+2}px;height:${badgeSize+2}px;font-size:${badgeFontSize+2}px;">E</div>`;
                            if(pState.boss === 'OSCURO') badges += `<div class="planet-badge badge-boss badge-boss-dark" style="width:${badgeSize+2}px;height:${badgeSize+2}px;font-size:${badgeFontSize+2}px;">O</div>`;
                            
                            if(pState.hasKey) badges += `<div class="planet-badge badge-key" style="width:${badgeSize+2}px;height:${badgeSize+2}px;font-size:${badgeFontSize+1}px;" title="Llave Singularidad">游딓勇</div>`;

                            if(pState.shops > 0) badges += `<div class="planet-badge badge-shop" style="width:${badgeSize}px;height:${badgeSize}px;font-size:${badgeFontSize}px;">${pState.shops}</div>`;
                            if(pState.eventObjects > 0) badges += `<div class="planet-badge badge-event" style="width:${badgeSize}px;height:${badgeSize}px;font-size:${badgeFontSize}px;">!</div>`;
                            if(pState.eventPortals > 0) badges += `<div class="planet-badge badge-portal" style="width:${badgeSize}px;height:${badgeSize}px;font-size:${badgeFontSize}px;">P</div>`;
                            if(pState.rebel > 0) badges += `<div class="planet-badge badge-danger" style="background-color:#ef4444;width:${badgeSize}px;height:${badgeSize}px;font-size:${badgeFontSize}px;">R</div>`;
                            if(pState.garbage > 0) badges += `<div class="planet-badge badge-danger" style="background-color:#f97316;width:${badgeSize}px;height:${badgeSize}px;font-size:${badgeFontSize}px;">B</div>`;
                            if(pState.eventNegative > 0 && pState.rebel === 0 && pState.garbage === 0) badges += `<div class="planet-badge badge-danger" style="width:${badgeSize}px;height:${badgeSize}px;font-size:${badgeFontSize}px;">X</div>`;

                            nodesHTML += `
                                <div class="planet-node active-node" style="left: ${p.x}%; top: ${p.y}%; width:${nodeSize}px; height:${nodeSize}px;" title="${p.id}">
                                    ${badges}
                                </div>
                            `;
                        });

                        // Nombre del sistema escalado y m치s visible
                        const labelFontSize = 0.4 * scaleFactor;
                        const labelOpacity = scaleFactor > 1.5 ? 0.9 : 0.7; // Mucho m치s visible
                        
                        cell.innerHTML = `
                            <div class="system-container">
                                ${data.systemDanger ? '<div class="system-danger-overlay"></div>' : ''}
                                ${data.systemInfected ? '<div class="system-infected-overlay"></div>' : ''}
                                ${svgHTML}
                                ${nodesHTML}
                                <div class="system-label-overlay" style="font-size: ${labelFontSize}rem; color: rgba(255,255,255,${labelOpacity}); text-shadow: 0 1px 3px rgba(0,0,0,0.8);">${data.systemName.replace('Sistema_', '').replace(/_/g, ' ')}</div>
                            </div>
                        `;
                    }

                    gridEl.appendChild(cell);
                }
            }
        }

        // --- CORE FUNCTIONS ---
        // (resetGame definition moved to SETUP section)

        function updateUIState() {
            const levelEl = document.getElementById('current-level');
            const phaseEl = document.getElementById('phase-label');
            const container = document.getElementById('level-container');
            const btn = document.getElementById('btn-next-level');

            levelEl.textContent = nivelActual;
            container.className = 'card p-6 mb-6 rounded-2xl text-center border-t-4 relative overflow-hidden'; // Reset
            levelEl.className = 'text-7xl font-black text-white';
            
            if (faseJuego === 'EXPANSION') {
                phaseEl.textContent = 'FASE: EXPANSI칍N UNIVERSAL';
                phaseEl.className = 'text-sm font-bold tracking-widest text-blue-400 uppercase mb-2 block';
                container.classList.add('border-[#1f6feb]');
                btn.innerHTML = '<i data-lucide="arrow-right-circle" class="w-4 h-4"></i> SIGUIENTE TURNO';
                btn.className = "btn btn-primary py-2 px-4 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2";
            } else if (faseJuego === 'CUENTA_ATRAS') {
                phaseEl.textContent = '丘멆잺 ALERTA: COLAPSO';
                phaseEl.className = 'text-sm font-bold tracking-widest text-orange-500 uppercase mb-2 block animate-pulse';
                container.classList.add('border-orange-500');
                levelEl.className = 'text-7xl font-black text-orange-500';
                const turnText = turnosParaBigCrunch === 1 ? "1 TURNO" : `${turnosParaBigCrunch} TURNOS`;
                btn.innerHTML = `<i data-lucide="timer" class="w-4 h-4"></i> CRUNCH EN ${turnText}`;
                btn.className = "btn btn-danger py-2 px-4 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2 bg-orange-600 border-orange-500";
            } else if (faseJuego === 'BIG_CRUNCH') {
                phaseEl.textContent = '游뚿 BIG CRUNCH 游뚿';
                phaseEl.className = 'text-sm font-bold tracking-widest text-red-500 uppercase mb-2 block';
                container.classList.add('crunch-mode', 'border-red-500'); 
                levelEl.className = 'text-7xl font-black text-red-500';
                btn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i> DESTRUIR NIVEL';
                btn.className = "btn btn-danger py-2 px-4 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2";
            }
            lucide.createIcons();
        }

        function handleTurnCycle() {
            const mapOutput = document.getElementById('map-output');

            if (faseJuego === 'EXPANSION') {
                if (nivelActual < 5) {
                    nivelActual++;
                    updateMapForLevel(nivelActual); // ACTUALIZAR VISUAL
                    
                    let msg = `Nivel ${nivelActual} Desbloqueado.`;
                    if (nivelActual === 5) {
                        faseJuego = 'CUENTA_ATRAS';
                        msg += " <span class='text-red-400 font-bold'>춰BIG CRUNCH INICIADO!</span>";
                        
                        // Mensaje explicativo de llaves
                        const keysNeeded = (activeRoles.length >= 3) ? 2 : 1;
                        msg += `<br><span class="text-yellow-300 text-[10px] mt-1 block border-t border-gray-700 pt-1">
                            OBJETIVO: Recuperad <strong class="text-white">${keysNeeded} Llave${keysNeeded>1?'s':''} de Singularidad</strong> de los sistemas de Nivel 5 antes de que colapsen.
                        </span>`;
                    }
                    mapOutput.innerHTML = `<p class="font-bold text-green-400 mb-1">EXPANSI칍N</p>${msg}`;
                    updateUIState();
                    return;
                }
            }

            if (faseJuego === 'CUENTA_ATRAS') {
                if (turnosParaBigCrunch > 0) {
                    turnosParaBigCrunch--;
                    if (turnosParaBigCrunch === 0) {
                        // APARECEN BOSSES (Turno 0, antes de destruir)
                        const bossLocations = spawnBosses();
                        mapOutput.innerHTML = `<p class="font-bold text-purple-400 mb-1">춰BOSSES!</p>En: ${bossLocations}<br><span class="text-red-400 text-[10px] mt-2 block border-t border-gray-700 pt-2"><strong>丘멆잺 ADVERTENCIA:</strong> Si vas al planeta del Boss y <strong>NO LO COMBATES</strong>, recibes <strong>-2 de vida</strong>.</span>`;
                    } else {
                        mapOutput.innerHTML = `<p class="font-bold text-orange-500 mb-1">CUENTA ATR츼S</p>Queda ${turnosParaBigCrunch} turno.`;
                    }
                    updateUIState();
                    return;
                } else {
                    faseJuego = 'BIG_CRUNCH';
                    mapOutput.innerHTML = `<p class="font-bold text-red-500 mb-1">춰IMPACTO!</p>El Nivel 5 ha sido destruido.`;
                    
                    // Destruir Nivel 5 del mapa visual
                    mapGrid.forEach((cell, idx) => { if(cell && cell.level === 5) mapGrid[idx] = null; });
                    renderMap();
                    
                    nivelActual = 4;
                    updateUIState();
                    return;
                }
            }

            if (faseJuego === 'BIG_CRUNCH') {
                if (nivelActual > 1) {
                    // Destruir nivel actual
                    mapGrid.forEach((cell, idx) => { if(cell && cell.level === nivelActual) mapGrid[idx] = null; });
                    
                    mapOutput.innerHTML = `<p class="font-bold text-red-500 mb-1">COLAPSO</p>Nivel ${nivelActual} consumido.`;
                    nivelActual--;
                    
                    if (nivelActual === 1) {
                         mapOutput.innerHTML += "<br><span class='text-red-300'>춰Vuelta al Nivel 1!</span>";
                    }
                    renderMap();
                    updateUIState();
                } else {
                    mapOutput.innerHTML = "Fin del Universo.";
                }
            }
        }

        function spawnBosses() {
            // Buscar planetas de Nivel 3
            let planetasN3 = [];
            mapGrid.forEach((cell, idx) => {
                if (cell && cell.level === 3) {
                    const planets = SYSTEM_PLANET_RELATION[cell.systemName];
                    if (planets) planetasN3 = planetasN3.concat(planets);
                }
            });

            if (planetasN3.length < 2) return "Error: No hay espacio."; 

            const chosen = shuffleArray(planetasN3).slice(0, 2);
            const bossTypes = ['ESTELAR', 'OSCURO']; // 0: Estelar, 1: Oscuro
            let locationMsg = [];

            chosen.forEach((planet, i) => {
                const type = bossTypes[i];
                const sysName = PLANET_TO_SYSTEM_MAP[planet];
                const cellIndex = mapGrid.findIndex(c => c && c.systemName === sysName);
                
                if (cellIndex !== -1) {
                    if (!mapGrid[cellIndex].planetStates) mapGrid[cellIndex].planetStates = {};
                    if (!mapGrid[cellIndex].planetStates[planet]) {
                        mapGrid[cellIndex].planetStates[planet] = {
                            shops:0, eventObjects:0, eventPortals:0, eventNegative:0, rebel:0, garbage:0, boss: null
                        };
                    }
                    // Asignar Boss
                    mapGrid[cellIndex].planetStates[planet].boss = type;
                    
                    // Formato bonito para el mensaje
                    const typeColor = type === 'ESTELAR' ? 'text-yellow-300' : 'text-purple-300';
                    locationMsg.push(`<br> <span class="${typeColor}">${type}</span> en <strong class="text-white">${planet}</strong>`);
                }
            });
            renderMap();
            return locationMsg.join('');
        }

        function generateShopLocations() {
            const detailOut = document.getElementById('shop-locations-details');
            
            // Limpiar shops previos (en planetStates)
            mapGrid.forEach(c => { 
                if(c && c.planetStates) {
                    Object.values(c.planetStates).forEach(st => st.shops = 0);
                }
            });

            let planetasActivos = [];
            for (let n = 2; n <= nivelActual; n++) {
                if (SISTEMAS_POR_NIVEL[n]) {
                    planetasActivos = planetasActivos.concat(SISTEMAS_POR_NIVEL[n].planetas);
                }
            }

            if (planetasActivos.length === 0) {
                detailOut.textContent = "Nivel 1: Sin tiendas.";
                renderMap();
                return;
            }

            let numSistemas = 0;
            mapGrid.forEach(c => { if(c && c.level > 1) numSistemas++; }); 

            const minShops = Math.max(1, Math.floor(numSistemas / 2));
            
            // Separar planetas de nivel 5 y otros niveles
            let planetasNivel5 = [];
            let planetasOtrosNiveles = [];
            
            planetasActivos.forEach(planet => {
                const system = PLANET_TO_SYSTEM_MAP[planet];
                const cellIndex = mapGrid.findIndex(c => c && c.systemName === system);
                if (cellIndex !== -1 && mapGrid[cellIndex].level === 5) {
                    planetasNivel5.push(planet);
                } else {
                    planetasOtrosNiveles.push(planet);
                }
            });

            // Para nivel 5: m치ximo 1 tienda por sistema
            let sistemasNivel5ConTienda = new Set();
            let selectedPlanets = [];
            
            // Primero asignar tiendas a nivel 5 (m치ximo 1 por sistema)
            const shuffledNivel5 = shuffleArray([...planetasNivel5]);
            for (const planet of shuffledNivel5) {
                const system = PLANET_TO_SYSTEM_MAP[planet];
                if (!sistemasNivel5ConTienda.has(system)) {
                    selectedPlanets.push(planet);
                    sistemasNivel5ConTienda.add(system);
                }
            }
            
            // Luego completar con otros niveles hasta alcanzar minShops
            const shuffledOtros = shuffleArray([...planetasOtrosNiveles]);
            for (const planet of shuffledOtros) {
                if (selectedPlanets.length >= minShops) break;
                selectedPlanets.push(planet);
            }

            // Asignar al mapa
            let locationListHTML = '<ul class="space-y-1">';
            
            selectedPlanets.forEach(planet => {
                const system = PLANET_TO_SYSTEM_MAP[planet];
                // Encontrar celda del sistema
                const cellIndex = mapGrid.findIndex(c => c && c.systemName === system);
                if (cellIndex !== -1 && mapGrid[cellIndex].planetStates) {
                    // Asignar tienda al planeta espec칤fico
                    if (!mapGrid[cellIndex].planetStates[planet]) {
                         mapGrid[cellIndex].planetStates[planet] = { shops: 0, eventObjects: 0, eventPortals: 0, eventNegative: 0 };
                    }
                    mapGrid[cellIndex].planetStates[planet].shops++;
                    locationListHTML += `<li><span class="text-blue-300">${planet}</span> <span class="text-[10px] text-gray-500">(${system.replace('Sistema_', '')})</span></li>`;
                }
            });
            locationListHTML += '</ul>';

            detailOut.innerHTML = locationListHTML;
            renderMap(); 
        }

        function generateItem(tipo, nivel, forcedRarity = null) {
            const itemsValidos = ITEMS_POR_TIPO[tipo].filter(item => item.niveles.includes(nivel));
            if (itemsValidos.length === 0) return null;
            const rareza = generateRareza(forcedRarity, nivel);
            let candidatos = itemsValidos.filter(i => i.rareza === rareza);
            
            // Filtrar legendarias que ya alcanzaron su l칤mite
            candidatos = candidatos.filter(item => {
                if (item.legendaria && item.maxApariciones) {
                    const apariciones = LEGENDARIAS_APARICIONES[item.id] || 0;
                    return apariciones < item.maxApariciones;
                }
                return true;
            });
            
            if (candidatos.length === 0) {
                // Si no hay candidatos v치lidos (todas las legendarias alcanzaron l칤mite), usar todos los items v치lidos sin filtrar legendarias
                candidatos = itemsValidos.filter(i => i.rareza === rareza);
                if (candidatos.length === 0) candidatos = itemsValidos;
            }
            
            const itemElegido = getRandomElement(candidatos);
            if (!itemElegido) return null;
            
            // Incrementar contador si es legendaria
            if (itemElegido.legendaria && itemElegido.maxApariciones) {
                if (!LEGENDARIAS_APARICIONES[itemElegido.id]) {
                    LEGENDARIAS_APARICIONES[itemElegido.id] = 0;
                }
                LEGENDARIAS_APARICIONES[itemElegido.id]++;
            }
            
            return { ...itemElegido, tipoObjeto: tipo }; 
        }

        function createItemCardHTML(item, compact = false) {
            if (!item) return '';
            const isLegendaria = item.legendaria && item.maxApariciones;
            const rarityClass = isLegendaria ? 'rarity-legendaria' : `rarity-${item.rareza}`;
            let icon = 'box';
            let colorText = 'text-gray-300';
            if(item.tipoObjeto === 'Vida') { icon = 'heart'; colorText = 'text-red-400'; }
            if(item.tipoObjeto === 'Combustible') { icon = 'flame'; colorText = 'text-orange-400'; }
            if(item.tipoObjeto === 'Potencia') { icon = 'zap'; colorText = 'text-yellow-400'; }
            if(item.tipoObjeto === 'Habilidad') { icon = 'star'; colorText = 'text-cyan-400'; }
            if(item.tipoObjeto === 'Especial') { icon = 'crown'; colorText = 'text-purple-400'; }

            let details = "";
            if (item.potenciaValor) details += `<span class="text-xs bg-gray-700 px-2 py-1 rounded text-white">Potencia: ${item.potenciaValor}</span>`;
            if (item.desc) details += `<p class="text-xs text-gray-400 mt-2 italic border-t border-gray-700 pt-1">"${item.desc}"</p>`;
            
            // Mensaje de legendaria
            if (isLegendaria) {
                const apariciones = LEGENDARIAS_APARICIONES[item.id] || 0;
                const restantes = item.maxApariciones - apariciones;
                details += `<p class="text-xs text-yellow-400 font-bold mt-2 border-t border-yellow-600/30 pt-1 bg-yellow-900/10 px-2 py-1 rounded">
                    救 LEGENDARIA: Aparece ${item.maxApariciones} vez${item.maxApariciones > 1 ? 'es' : ''} en total (${restantes} restante${restantes !== 1 ? 's' : ''})
                </p>`;
            }

            if (compact) {
                let compactDetails = "";
                if (item.potenciaValor) compactDetails += `<div class="mt-1"><span class="text-[10px] bg-gray-800 px-1.5 py-0.5 rounded text-yellow-200 border border-gray-700 inline-block font-mono">丘 Potencia: ${item.potenciaValor}</span></div>`;
                if (item.desc) compactDetails += `<p class="text-[10px] text-gray-400 italic mt-1">"${item.desc}"</p>`;
                if (isLegendaria) {
                    const apariciones = LEGENDARIAS_APARICIONES[item.id] || 0;
                    const restantes = item.maxApariciones - apariciones;
                    compactDetails += `<p class="text-[10px] text-yellow-400 font-bold mt-1 border-t border-yellow-600/30 pt-1">救 LEGENDARIA: ${item.maxApariciones} vez${item.maxApariciones > 1 ? 'es' : ''} total (${restantes} restante${restantes !== 1 ? 's' : ''})</p>`;
                }

                return `
                    <div class="event-item-preview p-3 bg-[#0b0e14] border border-gray-700 rounded-xl flex flex-col gap-1">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${icon}" class="w-4 h-4 ${colorText}"></i>
                                <span class="text-xs font-bold text-white">${item.id.replace(/_/g, ' ')}</span>
                            </div>
                            <span class="rarity-tag ${rarityClass} scale-90 origin-right">${isLegendaria ? 'LEGENDARIA' : item.rareza}</span>
                        </div>
                        ${compactDetails}
                    </div>
                `;
            }

            return `
                <div class="p-3 bg-[#0b0e14] border border-gray-700 rounded-xl flex flex-col gap-2 hover:border-gray-500 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${icon}" class="w-4 h-4 ${colorText}"></i>
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">${item.tipoObjeto}</span>
                        </div>
                        <span class="rarity-tag ${rarityClass}">${isLegendaria ? 'LEGENDARIA' : item.rareza}</span>
                    </div>
                    <div class="font-bold text-xs sm:text-sm text-white leading-tight">
                        ${item.id.replace(/_/g, ' ')}
                    </div>
                    <div class="mt-1">
                        ${details}
                    </div>
                </div>
            `;
        }

        function generateShopInventory() {
            const shopLevel = parseInt(document.getElementById('shop-level-select').value);
            const container = document.getElementById('shop-inventory-container');
            if (isNaN(shopLevel)) {
                container.innerHTML = '<div class="col-span-full text-center text-red-400 font-bold text-sm">춰Selecciona un nivel!</div>';
                return;
            }
            const tiposDisponibles = ['Potencia', 'Habilidad', 'Vida', 'Combustible'];
            let itemsData = [];
            for(let i=0; i<4; i++) {
                const tipoAleatorio = getRandomElement(tiposDisponibles);
                const item = generateItem(tipoAleatorio, shopLevel);
                itemsData.push(item);
            }
            if (shopLevel === 5) {
                const hasEpic = itemsData.some(i => i && i.rareza === 'epico');
                if (!hasEpic) {
                    const indexToReplace = Math.floor(Math.random() * 4);
                    const tipoForce = getRandomElement(tiposDisponibles); 
                    itemsData[indexToReplace] = generateItem(tipoForce, shopLevel, 'epico');
                }
            }
            if (Math.random() < 0.10) {
                 const especial = generateItem('Especial', shopLevel);
                 if(especial) itemsData.push(especial); 
            }
            container.innerHTML = itemsData.map(item => createItemCardHTML(item)).join('');
            lucide.createIcons();
        }

        function generateEvent() {
            const out = document.getElementById('event-output');
            out.innerHTML = ''; 
            
            // Reset previous event markers
            mapGrid.forEach(c => { 
                if(c) {
                    c.systemDanger = false; 
                    c.systemInfected = false;
                    if (c.planetStates) {
                        Object.values(c.planetStates).forEach(st => {
                            st.eventObjects = 0; 
                            st.eventPortals = 0; 
                            st.eventNegative = 0;
                            st.rebel = 0;
                            st.garbage = 0;
                            st.boss = null; // Borrar bosses al generar eventos
                        });
                    }
                }
            });
            
            let sistemasActivos = [];
            let planetasActivos = [];
            mapGrid.forEach(cell => {
                if (cell) {
                     const planets = SYSTEM_PLANET_RELATION[cell.systemName];
                     if (planets) planetasActivos = planetasActivos.concat(planets);
                     sistemasActivos.push(cell.systemName);
                }
            });

            if (nivelActual === 1) {
                out.innerHTML = "<p class='text-gray-400 text-center text-sm'>No hay eventos en el Nivel 1.</p>";
                renderMap();
                return;
            }

            let eventsHTML = '';

            // 1. POSITIVO (Siempre 1)
            // Portales 40%, Objetos 60%
            const isPortal = Math.random() < 0.40; 
            
            if (isPortal) {
                const targets = shuffleArray(planetasActivos).slice(0, Math.random() < 0.5 ? 2 : 3);
                targets.forEach(target => {
                    const sysName = PLANET_TO_SYSTEM_MAP[target];
                    const cellIndex = mapGrid.findIndex(c => c && c.systemName === sysName);
                    if (cellIndex !== -1 && mapGrid[cellIndex].planetStates) {
                        if (!mapGrid[cellIndex].planetStates[target]) mapGrid[cellIndex].planetStates[target] = {shops:0, eventObjects:0, eventPortals:0, eventNegative:0, rebel:0, garbage:0};
                        mapGrid[cellIndex].planetStates[target].eventPortals = 1;
                    }
                });

                eventsHTML += `
                    <div class="event-card event-positive">
                        <div class="event-section-title text-green-400">
                            <i data-lucide="door-open" class="w-4 h-4"></i> PORTAL
                        </div>
                        <p class="text-xs text-green-300 font-mono font-bold">${targets.join(' <-> ')}</p>
                    </div>
                `;
            } else {
                const targetPlanet = getRandomElement(planetasActivos);
                let randomObj;
                // 10% prob de Potencia 3
                if (Math.random() < 0.10) {
                    randomObj = getRandomElement(POTENCIA_3_POOL);
                } else {
                    randomObj = getRandomElement(EVENTO_OBJETOS_POOL);
                }

                const cardHTML = createItemCardHTML(randomObj, true);
                
                const sysName = PLANET_TO_SYSTEM_MAP[targetPlanet];
                const cellIndex = mapGrid.findIndex(c => c && c.systemName === sysName);
                if (cellIndex !== -1 && mapGrid[cellIndex].planetStates) {
                    if (!mapGrid[cellIndex].planetStates[targetPlanet]) mapGrid[cellIndex].planetStates[targetPlanet] = {shops:0, eventObjects:0, eventPortals:0, eventNegative:0, rebel:0, garbage:0};
                    mapGrid[cellIndex].planetStates[targetPlanet].eventObjects++;
                }

                eventsHTML += `
                    <div class="event-card event-positive">
                        <div class="event-section-title text-green-400">
                            <i data-lucide="gift" class="w-4 h-4"></i> OBJETO
                        </div>
                        <p class="text-xs text-gray-300 mb-1">En <strong class="text-white">${targetPlanet}</strong>:</p>
                        ${cardHTML}
                    </div>
                `;
            }

            // --- 2. EVENTO PERSONAL (ADAPTATIVO) ---
            
            // L칩gica seg칰n n칰mero de jugadores activos (activeRoles)
            // 1 Jugador: Sin eventos personales.
            // 2 Jugadores: 1 Evento Personal (afecta a 1).
            // 3 Jugadores: 50% 1 Evento, 50% 2 Eventos (afectando a distintos).
            // 4 Jugadores: Siempre 2 Eventos (afectando a distintos).

            const numPlayers = activeRoles.length;
            let numPersonalEvents = 0;

            if (numPlayers === 1) {
                numPersonalEvents = 0;
            } else if (numPlayers === 2) {
                numPersonalEvents = 1;
            } else if (numPlayers === 3) {
                numPersonalEvents = Math.random() < 0.5 ? 1 : 2;
            } else if (numPlayers >= 4) {
                numPersonalEvents = 2;
            }

            if (numPersonalEvents > 0) {
                // Seleccionar v칤ctimas 칰nicas de los roles activos
                const shuffledRoles = shuffleArray([...activeRoles]); 
                const victims = shuffledRoles.slice(0, numPersonalEvents);

                victims.forEach(victimRole => {
                    let pEventBase;
                    const randP = Math.random();
                    // Interferencias (Epico, 10%)
                    if (randP < 0.10) {
                        pEventBase = EVENTOS_PERSONALES_POOL.find(e => e.id === 'Interferencias');
                    } else {
                        const commons = EVENTOS_PERSONALES_POOL.filter(e => e.rareza !== 'epico');
                        pEventBase = getRandomElement(commons);
                    }
                    
                    const pDesc = pEventBase.desc.replace('{ROLE}', victimRole);
                    
                    eventsHTML += `
                        <div class="event-card bg-orange-900/20 border-l-4 border-orange-500">
                            <div class="event-section-title text-orange-400">
                                <i data-lucide="user-x" class="w-4 h-4"></i> ${pEventBase.id.replace(/_/g, ' ')}
                            </div>
                            <p class="text-xs text-gray-300 leading-relaxed">${pDesc}</p>
                        </div>
                    `;
                });
            }

            // Funci칩n Helper para Negativo General
            function generateNegativeGeneralHTML() {
                // 50% Sistema, 50% Planeta
                let evType = Math.random() < 0.5 ? 'SISTEMA' : 'PLANETA';
                let evName = '';
                
                if (evType === 'SISTEMA') {
                    // 75% Infectado, 25% Explosion
                    evName = Math.random() < 0.75 ? 'Evento_Sistema_Infectado' : 'Evento_Explosion_Sistema';
                } else {
                    // Planeta: Basura, Rebelde
                    evName = getRandomElement(EVENTOS_NEGATIVOS_PLANETA);
                }

                let titulo = evName.replace(/_/g, ' ');
                let desc = "";
                let icon = "alert-octagon";
                let styleClass = "event-negative";
                let targetSysName = null;
                let targetPlanetName = null; 

                if (evName === 'Evento_Explosion_Sistema') {
                    // Filtrar Sistema Tierra y Nivel 2 (hasta que empiece Big Crunch - CUENTA_ATRAS)
                    let validTargets = sistemasActivos.filter(s => {
                        if (s === 'Sistema_Tierra') return false;
                        
                        // Proteger Nivel 2 durante EXPANSION (antes de que se inicie el Big Crunch)
                        if (faseJuego === 'EXPANSION') {
                            const cellIndex = mapGrid.findIndex(c => c && c.systemName === s);
                            if (cellIndex !== -1 && mapGrid[cellIndex].level === 2) return false;
                        }
                        
                        return true;
                    });
                    
                    // Si no hay objetivos v치lidos para explosi칩n (ej: estamos en nivel 2 y todo est치 protegido),
                    // CAMBIAR A INFECTADO en lugar de forzar explosi칩n
                    if(validTargets.length === 0) {
                        evName = 'Evento_Sistema_Infectado'; // Switch event type
                        // Continue to Infected logic below...
                    } else {
                        const target = getRandomElement(validTargets); 
                        targetSysName = target;
                        desc = `Sistema <strong class="text-white">${target.replace('Sistema_','')}</strong> explotar치.`;
                        icon = "flame";
                    }
                } 
                
                // NOTA: Usamos if separado, no else if, porque evName puede haber cambiado arriba
                if (evName === 'Evento_Sistema_Infectado') {
                    const target = getRandomElement(sistemasActivos); 
                    targetSysName = target;
                    desc = `Sistema <strong class="text-white">${target.replace('Sistema_','')}</strong> infectado (Da침o 1/turno).`;
                    icon = "skull"; 
                } else if (evName === 'Evento_Basura Espacial') {
                    const target = getRandomElement(planetasActivos); 
                    targetSysName = PLANET_TO_SYSTEM_MAP[target];
                    targetPlanetName = target;
                    desc = `Basura en <strong class="text-white">${target}</strong> (Da침o 2).`;
                    icon = "satellite";
                } else if (evName === 'Planeta_Rebelde') { 
                    const target = getRandomElement(planetasActivos); 
                    targetSysName = PLANET_TO_SYSTEM_MAP[target];
                    targetPlanetName = target;
                    desc = `Rebeli칩n en <strong class="text-white">${target}</strong> (Da침o 1).`;
                    icon = "shield-alert";
                }

                // Update Map
                if (targetSysName) {
                    const cellIndex = mapGrid.findIndex(c => c && c.systemName === targetSysName);
                    if (cellIndex !== -1 && mapGrid[cellIndex].planetStates) {
                        if (evName === 'Evento_Explosion_Sistema') {
                             mapGrid[cellIndex].systemDanger = true;
                        } else if (evName === 'Evento_Sistema_Infectado') {
                             mapGrid[cellIndex].systemInfected = true;
                        } else if (targetPlanetName) {
                            if (!mapGrid[cellIndex].planetStates[targetPlanetName]) mapGrid[cellIndex].planetStates[targetPlanetName] = {shops:0, eventObjects:0, eventPortals:0, eventNegative:0, rebel:0, garbage:0};
                            if (evName === 'Planeta_Rebelde') mapGrid[cellIndex].planetStates[targetPlanetName].rebel = 1;
                            else if (evName === 'Evento_Basura Espacial') mapGrid[cellIndex].planetStates[targetPlanetName].garbage = 1;
                        }
                    }
                }

                return `
                    <div class="event-card ${styleClass}">
                        <div class="event-section-title text-red-400">
                            <i data-lucide="${icon}" class="w-4 h-4"></i> ${titulo}
                        </div>
                        <p class="text-xs text-gray-300 leading-relaxed">${desc}</p>
                    </div>
                `;
            }

            // --- 3. EVENTOS NEGATIVOS GENERALES (SIEMPRE 2) ---
            eventsHTML += generateNegativeGeneralHTML();
            eventsHTML += generateNegativeGeneralHTML();

            // --- 4. EVENTO EXTRA (50%) ---
            if (Math.random() < 0.50) {
                eventsHTML += `<div class="text-xs text-center text-yellow-500 font-bold uppercase tracking-widest my-1 border-t border-b border-yellow-900 py-1">춰EVENTO EXTRA!</div>`;
                // Generamos uno negativo general extra
                eventsHTML += generateNegativeGeneralHTML();
            }

            out.innerHTML = eventsHTML;
            renderMap(); 
            lucide.createIcons();
        }

        // INIT
        window.onload = () => {
            initMap();
            updateUIState();
            
            // Protecci칩n contra recarga accidental (F5)
            window.addEventListener('beforeunload', (e) => {
                e.preventDefault();
                e.returnValue = ''; // Standard for Chrome/Firefox
                return ''; // Legacy
            });
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // Detectar si estamos en GitHub Pages (/docs) o ra칤z
                    const swPath = window.location.pathname.includes('/docs') 
                        ? '/docs/service-worker.js' 
                        : '/service-worker.js';
                    
                    navigator.serviceWorker.register(swPath)
                        .then((registration) => {
                            console.log('SW registrado:', registration.scope);
                        })
                        .catch((error) => {
                            console.log('SW fall칩:', error);
                        });
                });
            }
        };

    </script>
</body>
</html>
